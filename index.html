<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Covey To‚ÄëDo ¬∑ Minimal + Sync (Accent) ¬∑ v36.2</title>
<meta name="theme-color" content="#2563eb" id="themeColorMeta">
<style>
/*
  Covey To‚ÄëDo v36.2
  - Restores original Add screen look (pill input, bold blue Add button, rounded chips)
  - Dark mode keeps colored primary buttons
  - Step 2 uses compact LIST layout (not tall cards) for Categorise & Prioritise
  - Retains cleaned codebase & sync from v36-clean
*/

:root{
  --accent:#2563eb; /* primary */
  --bg:#f7f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
  --pill-bg:#f3f4f6; --pill-text:#374151; --shadow:0 1px 2px rgba(0,0,0,.05), 0 6px 16px rgba(0,0,0,.04);
  --btn-h:46px; --btn-radius:12px; --card-max:860px;
  --q1:#ef4444; --q2:#10b981; --q3:#f59e0b; --q4:#6366f1;
}
[data-theme="dark"]{
  --bg:#0b0c10; --card:#111317; --text:#f5f7fb; --muted:#9aa0a6; --border:#24272c;
  --pill-bg:#1b1e24; --pill-text:#cbd5e1; --shadow:0 1px 2px rgba(0,0,0,.6), 0 6px 18px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:0 auto;padding:16px;text-align:center}
header{margin:6px 0 12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
h1{font-size:20px;margin:0}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:var(--card-max);margin:12px auto}

/* Buttons */
.btn{appearance:none;border:1px solid var(--border);background:var(--card);padding:0 18px;border-radius:var(--btn-radius);font-weight:800;cursor:pointer;color:var(--text);min-height:var(--btn-h);display:inline-flex;align-items:center;justify-content:center;transition:transform .07s ease,box-shadow .12s ease,background .12s ease,color .12s ease}
.btn:hover{box-shadow:0 2px 6px rgba(0,0,0,.08);transform:translateY(-1px)}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important}
.btn.ghost{background:var(--card);}
.btn.pill{border-radius:999px}
.btn.sm{min-height:36px;padding:0 12px;font-weight:700;border-radius:10px}
.toggle{border-radius:999px;min-width:46px;min-height:46px;padding:0}

/* Stepper */
.btnrow{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;max-width:var(--card-max);margin:10px auto}
.btnrow>.btn{flex:1 1 0;max-width:240px}

/* Input row (match screenshot: rounded input + bold blue Add) */
#addForm{display:grid;grid-template-columns:1fr auto;gap:12px}
input[type="text"],textarea{border:1px solid var(--border);border-radius:999px;padding:12px 16px;width:100%;background:var(--card);color:var(--text)}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;max-width:var(--card-max);margin:12px auto 0}
.chip{border:1px solid var(--border);background:var(--card);border-radius:999px;font-size:13px;padding:10px 14px;cursor:pointer;color:var(--text);transition:transform .08s ease,box-shadow .12s ease}
.chip:hover{transform:translateY(-1px);box-shadow:0 1px 3px rgba(0,0,0,.12)}

/* Lists */
.list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;text-align:left}
.task{position:relative;display:flex;gap:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px;align-items:center;box-shadow:var(--shadow)}
.title{font-weight:800;white-space:normal;word-break:normal;overflow-wrap:anywhere;line-height:1.25}
.strike{text-decoration:line-through;opacity:.7}
.spacer{flex:1 1 auto}
.pill{font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--pill-bg);color:var(--pill-text)}
.closebtn{border-color:rgba(239,68,68,.4);color:#ef4444;background:transparent}
.closebtn:hover{background:rgba(239,68,68,.08)}

/* View transitions */
.view{max-height:0;opacity:0;transform:translateY(6px);overflow:hidden;transition:opacity .2s ease,transform .2s ease,max-height .25s ease}
.view.active{max-height:4000px;opacity:1;transform:none}

/* Quadrants */
.quads{display:grid;grid-template-columns:1fr;gap:12px;max-width:var(--card-max);margin:0 auto}
@media(min-width:760px){.quads{grid-template-columns:1fr 1fr}}
.quads .card .sec-title{font-size:13.5px;letter-spacing:.06em;font-weight:800;padding:12px 14px;border-radius:10px;display:block;width:100%;margin-bottom:6px;background:var(--pill-bg);border:1px solid var(--border)}
.quads .card:nth-child(1) .sec-title{border-left:6px solid var(--q1);padding-left:10px}
.quads .card:nth-child(2) .sec-title{border-left:6px solid var(--q2);padding-left:10px}
.quads .card:nth-child(3) .sec-title{border-left:6px solid var(--q3);padding-left:10px}
.quads .card:nth-child(4) .sec-title{border-left:6px solid var(--q4);padding-left:10px}
.task.q-Q1{border-left:4px solid var(--q1)}
.task.q-Q2{border-left:4px solid var(--q2)}
.task.q-Q3{border-left:4px solid var(--q3)}
.task.q-Q4{border-left:4px solid var(--q4)}
.qpill{font-size:11px;border:1px solid var(--border);padding:3px 7px;border-radius:999px;background:var(--pill-bg);color:var(--pill-text);margin-left:8px;line-height:1}

/* Step 2 LIST layout controls (right-aligned mini buttons) */
.row-actions{display:flex;gap:8px;align-items:center}
.btn.icon{min-width:36px;min-height:36px;padding:0 0;border-radius:10px}
.btn.icon span{font-size:16px;line-height:1}

/* Accessible checkboxes */
input[type="checkbox"]{-webkit-appearance:none;appearance:none;width:18px;height:18px;margin:0 8px 0 0;border-radius:6px;border:2px solid var(--muted);background:var(--pill-bg);display:inline-grid;place-content:center;transition:background .12s ease,border-color .12s ease,box-shadow .12s ease,transform .05s ease}
input[type="checkbox"]:hover{transform:translateY(-1px)}
input[type="checkbox"]:focus{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.35)}
input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
input[type="checkbox"]:checked::after{content:"";width:10px;height:6px;border:2px solid #fff;border-top:0;border-left:0;transform:translateY(-1px) rotate(45deg)}

/* Enhanced Responsive Design */
@media (max-width:560px){
  .btnrow>.btn{max-width:100%}
  .container{padding:12px}
  h1{font-size:18px}
  .quads{grid-template-columns:1fr;gap:8px}
  .task{padding:10px;gap:8px}
  .btn.icon{min-width:32px;min-height:32px}
  #addForm{grid-template-columns:1fr;gap:8px}
  #addForm button{justify-self:stretch}
}

/* Loading states */
.loading {
  opacity: 0.6;
  pointer-events: none;
  position: relative;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid var(--muted);
  border-top: 2px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Better hover states */
.chip:hover,
.task:hover {
  border-color: var(--accent);
  box-shadow: 0 2px 8px rgba(37,99,235,0.15);
}

/* Focus styles */
.btn:focus-visible,
input:focus-visible,
textarea:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Improved animations */
.task {
  transition: all 0.2s ease;
}

.task:hover {
  transform: translateY(-1px);
}

.view {
  transition: opacity .3s ease, transform .3s ease, max-height .4s ease;
}

/* Success states */
.success-flash {
  animation: successFlash 0.6s ease;
}

@keyframes successFlash {
  0% { background-color: var(--card); }
  50% { background-color: rgba(16,185,129,0.1); }
  100% { background-color: var(--card); }
}

/* Empty state styling */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
}

.empty-state::before {
  content: 'üìù';
  font-size: 48px;
  display: block;
  margin-bottom: 16px;
  opacity: 0.5;
}

/* Better card spacing on larger screens */
@media (min-width: 1200px) {
  .container { max-width: 1100px; }
  .card { padding: 20px; }
  .quads { gap: 16px; }
}
</style>
</head>
<body>
<div class="container" id="root">
  <header>
    <button id="themeToggle" class="btn pill ghost toggle" aria-label="Toggle theme">üåì</button>
    <h1 style="margin:0 auto">Covey To‚ÄëDo</h1>
    <div class="row" style="justify-content:flex-end; gap:12px">
      <span id="syncStatus" class="btn pill ghost" style="min-height:36px;font-weight:700">Sync: Off</span>
      <button id="settingsBtn" class="btn pill ghost" aria-haspopup="dialog" aria-controls="settingsModal">‚öôÔ∏é</button>
    </div>
  </header>

  <!-- Stepper -->
  <nav class="btnrow" id="stepper" role="tablist" aria-label="Todo app steps">
    <button id="step1Btn" class="btn pill primary" role="tab" aria-selected="true" aria-controls="step1" tabindex="0">1. Add</button>
    <button id="step2Btn" class="btn pill ghost" role="tab" aria-selected="false" aria-controls="step2" tabindex="-1">2. Categorise & Prioritise</button>
    <button id="step3Btn" class="btn pill ghost" role="tab" aria-selected="false" aria-controls="step3" tabindex="-1">3. Current list</button>
  </nav>

  <!-- Step 1: Add -->
  <section id="step1" class="view active" role="tabpanel" aria-labelledby="step1Btn" aria-hidden="false">
    <div class="card">
      <form id="addForm" aria-label="Add new task">
        <input id="taskInput" type="text" placeholder="Add a task‚Ä¶" aria-label="Task description" required maxlength="200" autocomplete="off" />
        <button type="submit" class="btn pill primary" aria-label="Add task">Add</button>
      </form>
      <div id="suggestions" class="chips" role="group" aria-label="Task suggestions"></div>
    </div>

    <div class="card">
      <ul id="inboxList" class="list" role="list" aria-label="Uncategorized tasks"></ul>
    </div>
  </section>

  <!-- Step 2: Categorise + Prioritise (LIST layout) -->
  <section id="step2" class="view" role="tabpanel" aria-labelledby="step2Btn" aria-hidden="true">
    <div class="card" id="categoriseBox" role="region" aria-label="Task categorization"></div>
    <div class="quads" role="region" aria-label="Eisenhower Matrix - Task Quadrants">
      <div class="card">
        <h3 class="sec-title" id="q1-title">Q1 ¬∑ Urgent + Important</h3>
        <ul id="listQ1" class="list" role="list" aria-labelledby="q1-title"></ul>
      </div>
      <div class="card">
        <h3 class="sec-title" id="q2-title">Q2 ¬∑ Not Urgent + Important</h3>
        <ul id="listQ2" class="list" role="list" aria-labelledby="q2-title"></ul>
      </div>
      <div class="card">
        <h3 class="sec-title" id="q3-title">Q3 ¬∑ Urgent + Not Important</h3>
        <ul id="listQ3" class="list" role="list" aria-labelledby="q3-title"></ul>
      </div>
      <div class="card">
        <h3 class="sec-title" id="q4-title">Q4 ¬∑ Not Urgent + Not Important</h3>
        <ul id="listQ4" class="list" role="list" aria-labelledby="q4-title"></ul>
      </div>
    </div>
  </section>

  <!-- Step 3: Current list -->
  <section id="step3" class="view" role="tabpanel" aria-labelledby="step3Btn" aria-hidden="true">
    <div class="card">
      <div class="btnrow" style="margin-bottom:8px">
        <label class="btn pill ghost" style="gap:8px; min-height:36px; min-width:auto">
          <input id="showCompleted" type="checkbox" style="accent-color:var(--accent)"> Show completed
        </label>
        <button id="clearBtn" class="btn pill ghost" aria-label="Clear all tasks">Clear all</button>
      </div>
      <ul id="currentList" class="list" role="list" aria-label="All tasks by priority"></ul>
    </div>
  </section>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Settings" style="position:fixed;inset:0;background:rgba(0,0,0,.15);display:none;align-items:center;justify-content:center;padding:16px">
  <div class="sheet" style="background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:560px;width:100%;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.12);text-align:left">
    <div class="row" style="justify-content:center; gap:12px; margin-bottom:6px; display:flex; align-items:center">
      <h2 style="margin:0;font-size:16px; text-align:center; flex:1">Settings</h2>
      <button id="closeSettings" class="btn pill ghost" aria-label="Close settings">‚úï</button>
    </div>
    <div class="row" style="margin-top:8px; justify-content:center; gap:12px; display:flex; align-items:center">
      <label class="row" style="gap:8px; display:flex; align-items:center"><input id="enableSync" type="checkbox"> Enable sync</label>
      <div class="btn pill ghost" id="envStatus" style="min-height:36px;font-weight:700">SDK: not loaded</div>
    </div>
    <div style="margin-top:10px">
      <label class="muted" style="font-size:12px">Firebase web config (JSON). Preloaded; edit only if you need to override.</label>
      <textarea id="firebaseConfig" rows="6" placeholder='{"apiKey":"","authDomain":"","projectId":"","appId":""}' style="width:100%"></textarea>
    </div>
    <div class="row" style="gap:12px; margin-top:10px; display:flex">
      <div style="flex:1">
        <label class="muted" style="font-size:12px">Room code</label>
        <input id="roomCode" type="text" placeholder="e.g., my-team" />
      </div>
      <div style="flex:1">
        <label class="muted" style="font-size:12px">Your name (optional)</label>
        <input id="displayName" type="text" placeholder="e.g., Sam" />
      </div>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">
    <div>
      <div class="sec-title">Accent colour</div>
      <div class="swatches" id="accentSwatches" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px"></div>
      <div class="colorrow" style="display:flex;align-items:center;gap:10px;margin-top:8px">
        <input type="color" id="accentCustom" value="#2563eb" />
        <button id="accentApply" class="btn pill ghost">Apply custom</button>
      </div>
    </div>
    <div class="btnrow" style="margin-top:12px">
      <button id="saveSettings" class="btn pill primary">Save & connect</button>
      <span id="connectStatus" class="btn pill ghost" style="min-width:auto;min-height:36px;font-weight:700">Idle</span>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js" defer></script>

<script>
/* ========= Theme ========= */
const THEME_KEY = "covey_theme_pref";
const ACCENT_KEY = "covey_accent_pref";
function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); }
function systemPrefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
function initTheme(){ const saved = localStorage.getItem(THEME_KEY); const t = saved || (systemPrefersDark() ? 'dark' : 'light'); applyTheme(t); }
function toggleTheme(){ const cur = document.documentElement.getAttribute('data-theme') || 'light'; const next = cur === 'dark' ? 'light' : 'dark'; applyTheme(next); localStorage.setItem(THEME_KEY, next); }
initTheme();

/* ========= Accent ========= */
const themeMeta = document.getElementById('themeColorMeta');
function applyAccent(hex){ document.documentElement.style.setProperty('--accent', hex); if(themeMeta) themeMeta.setAttribute('content', hex); localStorage.setItem(ACCENT_KEY, hex); }
function initAccent(){ const saved = localStorage.getItem(ACCENT_KEY); if(saved){ applyAccent(saved); } }

/* ========= Local state ========= */
const STORAGE_KEY = "covey_minimal_v4";
const SYNC_KEY = "covey_sync_settings_v1";
let tasks = loadLocal();
let step = 1;
let answeredUrgent = null;
let showCompleted = false;

// Performance optimization: track what needs re-rendering
let renderState = {
  step1: true,
  step2: true, 
  step3: true,
  suggestions: true
};

// Debounce helper for input handling
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function loadLocal(){ 
  try{ 
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    const parsed = JSON.parse(data);
    if (!Array.isArray(parsed)) {
      console.warn('Invalid data format in localStorage, resetting to empty array');
      return [];
    }
    return parsed;
  } catch(e){ 
    console.error('Failed to load from localStorage:', e);
    showError('Failed to load saved tasks. Starting with empty list.');
    return []; 
  } 
}
function saveLocal(){ 
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); 
  } catch(error) {
    console.error('Failed to save to localStorage:', error);
    showError('Failed to save data. Your changes may not be preserved.');
  }
}
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function nowMs(){ return Date.now(); }
function num(v){ return (v===undefined||v===null)? Number.POSITIVE_INFINITY : Number(v); }

/* ========= Derived helpers ========= */
function inbox(includeCompleted){ return tasks.filter(t=>!t.quadrant && (includeCompleted || !t.completed)); }
function groups(includeCompleted){ const g = {Q1:[],Q2:[],Q3:[],Q4:[]}; tasks.forEach(t=>{ if(t.quadrant && (includeCompleted || !t.completed)) g[t.quadrant].push(t); }); for(const q of ['Q1','Q2','Q3','Q4']) g[q].sort((a,b)=> (num(a.rank)-num(b.rank)) || (a.createdAt-b.createdAt)); return g; }
function allSorted(includeCompleted){ const g = groups(includeCompleted); return [...g.Q1, ...g.Q2, ...g.Q3, ...g.Q4]; }

/* ========= DOM refs ========= */
const el = {
  step1: byId('step1'), step2: byId('step2'), step3: byId('step3'),
  step1Btn: byId('step1Btn'), step2Btn: byId('step2Btn'), step3Btn: byId('step3Btn'),
  addForm: byId('addForm'), taskInput: byId('taskInput'),
  inboxList: byId('inboxList'),
  listQ1: byId('listQ1'), listQ2: byId('listQ2'), listQ3: byId('listQ3'), listQ4: byId('listQ4'),
  categoriseBox: byId('categoriseBox'), suggestions: byId('suggestions'),
  showCompleted: byId('showCompleted'), clearBtn: byId('clearBtn'), currentList: byId('currentList'),
  settingsBtn: byId('settingsBtn'), settingsModal: byId('settingsModal'), closeSettings: byId('closeSettings'),
  firebaseConfig: byId('firebaseConfig'), roomCode: byId('roomCode'), displayName: byId('displayName'),
  enableSync: byId('enableSync'), saveSettings: byId('saveSettings'),
  syncStatus: byId('syncStatus'), connectStatus: byId('connectStatus'), envStatus: byId('envStatus'),
  accentSwatches: byId('accentSwatches'), accentCustom: byId('accentCustom'), accentApply: byId('accentApply')
};
document.getElementById('themeToggle').onclick = toggleTheme;

/* ========= Keyboard Navigation ========= */
// Tab navigation for stepper
document.addEventListener('keydown', (e) => {
  if (e.target.closest('#stepper')) {
    const buttons = [el.step1Btn, el.step2Btn, el.step3Btn];
    const currentIndex = buttons.findIndex(btn => btn === e.target);
    
    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
      e.preventDefault();
      const direction = e.key === 'ArrowLeft' ? -1 : 1;
      const newIndex = (currentIndex + direction + buttons.length) % buttons.length;
      buttons[newIndex].focus();
      setStep(newIndex + 1);
    } else if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      setStep(currentIndex + 1);
    }
  }
  
  // ESC to close modal
  if (e.key === 'Escape' && el.settingsModal.style.display === 'flex') {
    closeSettings();
  }
  
  // Focus management for modal
  if (el.settingsModal.style.display === 'flex' && e.key === 'Tab') {
    trapFocus(e, el.settingsModal);
  }
});

function trapFocus(e, container) {
  const focusableElements = container.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
  const firstElement = focusableElements[0];
  const lastElement = focusableElements[focusableElements.length - 1];
  
  if (e.shiftKey) {
    if (document.activeElement === firstElement) {
      lastElement.focus();
      e.preventDefault();
    }
  } else {
    if (document.activeElement === lastElement) {
      firstElement.focus();
      e.preventDefault();
    }
  }
}

/* ========= Accent UI ========= */
const PRESET_ACCENTS = ["#2563eb","#7c3aed","#db2777","#ef4444","#059669","#0ea5e9","#f59e0b","#111827"];
function buildSwatches(){ el.accentSwatches.innerHTML = ""; const current = localStorage.getItem(ACCENT_KEY) || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(); PRESET_ACCENTS.forEach(hex=>{ const b = document.createElement('button'); b.className = 'chip'; b.style.borderRadius='999px'; b.style.background=hex; b.style.color='#fff'; b.style.border='1px solid var(--border)'; b.style.minWidth='36px'; b.style.height='28px'; b.title=hex; b.type='button'; b.onclick = ()=>{ applyAccent(hex); buildSwatches(); }; el.accentSwatches.appendChild(b); }); }
el.accentApply.onclick = ()=>{ applyAccent(el.accentCustom.value); buildSwatches(); };

/* ========= Step nav ========= */
el.step1Btn.onclick = ()=> setStep(1);
el.step2Btn.onclick = ()=> setStep(2);
el.step3Btn.onclick = ()=> setStep(3);

function setStep(n){ 
  if (step === n) return; // Don't re-render if already on this step
  
  step = n; 
  const sections = [el.step1, el.step2, el.step3]; 
  const buttons = [el.step1Btn, el.step2Btn, el.step3Btn]; 
  
  sections.forEach((sec, idx)=>{ 
    if(idx === n-1){ 
      sec.classList.add('active'); 
      sec.setAttribute('aria-hidden','false'); 
    } else { 
      sec.classList.remove('active'); 
      sec.setAttribute('aria-hidden','true'); 
    } 
  }); 
  
  buttons.forEach((btn, idx)=>{ 
    if(idx === n-1){ 
      btn.className = 'btn pill primary'; 
      btn.setAttribute('aria-selected', 'true'); 
      btn.setAttribute('tabindex', '0'); 
    } else { 
      btn.className = 'btn pill ghost'; 
      btn.setAttribute('aria-selected', 'false'); 
      btn.setAttribute('tabindex', '-1'); 
    } 
  }); 
  
  // Only re-render the current step
  const updateMap = {};
  updateMap[`step${n}`] = true;
  render(updateMap);
}

/* ========= Add form ========= */
el.addForm.onsubmit = (e)=>{ 
  e.preventDefault(); 
  const v = el.taskInput.value.trim(); 
  
  // Input validation
  if(!v) {
    showError('Please enter a task description');
    el.taskInput.focus();
    return; 
  }
  
  if(v.length > 200) {
    showError('Task description must be less than 200 characters');
    el.taskInput.focus();
    return;
  }
  
  // Check for duplicate tasks
  if(tasks.some(t => t.title.toLowerCase() === v.toLowerCase())) {
    showError('A task with this description already exists');
    el.taskInput.focus();
    return;
  }
  
  try {
    addLoadingState(el.addForm);
    tasks.unshift({id:uid(), title:v, completed:false, quadrant:null, rank:null, createdAt:nowMs(), updatedAt:nowMs()}); 
    el.taskInput.value=''; 
    saveLocal(); 
    queueUpload(); 
    
    // Only update step1 and suggestions
    markForUpdate(['step1']);
    renderState.suggestions = true;
    render();
    
    // Visual feedback
    removeLoadingState(el.addForm);
    addSuccessFlash(el.inboxList);
    showSuccess('Task added successfully');
    
    // Focus back to input for quick task entry
    setTimeout(() => el.taskInput.focus(), 100);
  } catch(error) {
    removeLoadingState(el.addForm);
    console.error('Error adding task:', error);
    showError('Failed to add task. Please try again.');
  }
};

// Add debounced input handler for real-time suggestions
const debouncedSuggestionUpdate = debounce(() => {
  if (step === 1) {
    renderState.suggestions = true;
    render({ suggestions: true });
  }
}, 300);

// Update suggestions as user types
el.taskInput.addEventListener('input', debouncedSuggestionUpdate);

/* ========= Current list controls ========= */
el.showCompleted.onchange = ()=>{ 
  showCompleted = el.showCompleted.checked; 
  markForUpdate(['step3']);
  render(); 
};
el.clearBtn.onclick = ()=>{ 
  const taskCount = tasks.length;
  if(taskCount === 0) {
    showInfo('No tasks to clear');
    return;
  }
  
  const confirmed = confirm(`Are you sure you want to delete all ${taskCount} tasks?\n\nThis action cannot be undone.`);
  if(confirmed){ 
    try {
      addLoadingState(el.clearBtn);
      tasks=[]; 
      saveLocal(); 
      queueUpload(true); 
      markForUpdate(['step1', 'step2', 'step3']);
      renderState.suggestions = true;
      render();
      removeLoadingState(el.clearBtn);
      showSuccess(`Cleared ${taskCount} tasks successfully`);
    } catch(error) {
      removeLoadingState(el.clearBtn);
      console.error('Error clearing tasks:', error);
      showError('Failed to clear tasks. Please try again.');
    }
  } 
};

/* ========= Suggestions ========= */
function computeSuggestions(){ 
  try {
    const verbs = new Map(); 
    for(const t of tasks){ 
      const title = t.title || '';
      if (typeof title !== 'string') continue;
      const w = title.split(/\s+/)[0]?.toLowerCase() || '';
      if(!w) continue; 
      verbs.set(w, (verbs.get(w)||0)+1); 
    } 
    const common = Array.from(verbs.entries())
      .sort((a,b)=>b[1]-a[1])
      .map(([w])=>w)
      .filter(w => w.length > 2); // Filter out very short words
    const base = ["Plan","Book","Email","Call","Review","Draft","Schedule","Organise"]; 
    const pool = [...new Set([...common, ...base])].slice(0,8); 
    return pool.map(v => v.charAt(0).toUpperCase()+v.slice(1) + " ‚Ä¶"); 
  } catch(error) {
    console.error('Error computing suggestions:', error);
    return ["Plan ‚Ä¶", "Email ‚Ä¶", "Call ‚Ä¶", "Review ‚Ä¶"];
  }
}
function applySuggestion(s){ 
  try {
    const txt = s.endsWith(' ‚Ä¶') ? s.slice(0,-2) + ' ' : s + ' '; 
    el.taskInput.value = txt; 
    el.taskInput.focus(); 
    el.taskInput.setSelectionRange(txt.length, txt.length);
  } catch(error) {
    console.error('Error applying suggestion:', error);
    showError('Failed to apply suggestion');
  }
}

/* ========= Categorise flow ========= */
function answerUrgent(val){ 
  answeredUrgent = val; 
  markForUpdate(['step2']);
  render(); 
}

function answerImportant(val){ 
  const current = inbox(false)[0]; 
  if(!current) return; 
  
  const urgent = !!answeredUrgent; 
  const q = urgent ? (val ? 'Q1' : 'Q3') : (val ? 'Q2' : 'Q4'); 
  const maxRank = Math.max(-1, ...tasks.filter(t=>t.quadrant===q && t.rank!=null).map(t=>t.rank)); 
  
  current.quadrant = q; 
  current.rank = maxRank + 1; 
  current.updatedAt = nowMs(); 
  
  saveLocal(); 
  queueUpload(); 
  answeredUrgent = null; 
  
  // Update both step1 (inbox) and step2 (quadrants)
  markForUpdate(['step1', 'step2', 'step3']);
  render();
}

/* ========= Prioritise (LIST layout) ========= */
function moveWithinQuadrant(id, qKey, delta){ 
  const q = tasks.filter(t=>t.quadrant===qKey).sort((a,b)=> (num(a.rank)-num(b.rank)) || (a.createdAt-b.createdAt)); 
  const index = q.findIndex(x=>x.id===id); 
  if(index<0) return; 
  const target = index+delta; 
  if(target<0 || target>=q.length) return; 
  
  const a = q[index], b = q[target]; 
  const tmp = a.rank; 
  a.rank = b.rank; 
  b.rank = tmp; 
  
  normalizeRanks(qKey); 
  saveLocal(); 
  queueUpload(); 
  
  // Only update step2 and step3 (quadrants and current list)
  markForUpdate(['step2', 'step3']);
  render(); 
}

function normalizeRanks(qKey){ 
  const q = tasks.filter(t=>t.quadrant===qKey).sort((a,b)=> (num(a.rank)-num(b.rank)) || (a.createdAt-b.createdAt)); 
  q.forEach((t,i)=> { t.rank = i; t.updatedAt = nowMs(); }); 
}

/* ========= Performance-optimized Render ========= */
function render(forceUpdate = {}){
  // Merge force updates with render state
  const shouldUpdate = { ...renderState, ...forceUpdate };
  
  // Step 1 - Only update if needed
  if (shouldUpdate.step1) {
    renderStep1();
    renderState.step1 = false;
    renderState.suggestions = false; // Clear suggestions flag as renderStep1 includes them
  }
  
  // Step 2 - Only update if needed
  if (shouldUpdate.step2) {
    renderStep2();
    renderState.step2 = false;
  }
  
  // Step 3 - Only update if needed
  if (shouldUpdate.step3) {
    renderStep3();
    renderState.step3 = false;
  }
  
  // Update suggestions separately if needed (only if step1 wasn't updated)
  if (shouldUpdate.suggestions && !shouldUpdate.step1) {
    renderSuggestions();
    renderState.suggestions = false;
  }
}

function renderStep1() {
  const unc = inbox(false);
  updateList(el.inboxList, unc, {showQuadrant:false}, 'No tasks');
  renderSuggestions();
}

function renderStep2() {
  const g = groups(true);
  const current = inbox(false)[0];
  
  // Update categorization box
  updateCategoriseBox(current);
  
  // Update quadrant lists
  mountQuadrantList(el.listQ1, g.Q1, 'Q1');
  mountQuadrantList(el.listQ2, g.Q2, 'Q2');
  mountQuadrantList(el.listQ3, g.Q3, 'Q3');
  mountQuadrantList(el.listQ4, g.Q4, 'Q4');
}

function renderStep3() {
  const all = allSorted(showCompleted);
  updateList(el.currentList, all, {showQuadrant:true}, 'No tasks');
  el.showCompleted.checked = showCompleted;
}

function renderSuggestions() {
  const sugg = computeSuggestions(); 
  el.suggestions.innerHTML=''; 
  const fragment = document.createDocumentFragment();
  sugg.forEach(s => { 
    const b = document.createElement('button'); 
    b.className='chip'; 
    b.type='button'; 
    b.textContent=s; 
    b.onclick = ()=> applySuggestion(s); 
    fragment.appendChild(b); 
  });
  el.suggestions.appendChild(fragment);
}

// Optimized list update function with proper semantic empty states
function updateList(container, items, opts, emptyMessage) {
  if (!items.length) {
    const emptyLi = document.createElement('li');
    emptyLi.className = 'empty-state';
    emptyLi.setAttribute('role', 'listitem');
    emptyLi.setAttribute('aria-live', 'polite');
    emptyLi.innerHTML = `<p>${escapeHtml(emptyMessage)}</p>`;
    container.innerHTML = '';
    container.appendChild(emptyLi);
    return;
  }
  
  // Use document fragment for efficient DOM manipulation
  const fragment = document.createDocumentFragment();
  items.forEach(item => fragment.appendChild(rowItem(item, opts)));
  
  container.innerHTML = '';
  container.appendChild(fragment);
}

function updateCategoriseBox(current) {
  if(!current){ 
    el.categoriseBox.innerHTML = '<div class="muted" style="text-align:center" role="status">No uncategorised tasks.</div>'; 
  }
  else if(answeredUrgent===null){ 
    el.categoriseBox.innerHTML = `
      <div class="sec-title">Categorise</div>
      <div class="task"><div class="title">${escapeHtml(current.title)}</div><div class="spacer"></div></div>
      <div class="btnrow" style="margin-top:10px">
        <button class="btn pill primary" onclick="answerUrgent(true)">Urgent</button>
        <button class="btn pill ghost" onclick="answerUrgent(false)">Not urgent</button>
      </div>`; 
  }
  else { 
    el.categoriseBox.innerHTML = `
      <div class="sec-title">Categorise</div>
      <div class="task"><div class="title">${escapeHtml(current.title)}</div><div class="spacer"></div></div>
      <div class="btnrow" style="margin-top:10px">
        <button class="btn pill primary" onclick="answerImportant(true)">Important</button>
        <button class="btn pill ghost" onclick="answerImportant(false)">Not important</button>
      </div>
      <div class="btnrow" style="margin-top:8px">
        <button class="btn pill ghost" onclick="answerUrgent(null)">Back</button>
      </div>`; 
  }
}

// Mark what needs to be re-rendered
function markForUpdate(sections = ['step1', 'step2', 'step3']) {
  sections.forEach(section => {
    if (renderState.hasOwnProperty(section)) {
      renderState[section] = true;
    }
  });
}

// Safe render helper for forced updates
function forceRender(updateMap = {}) {
  const hasUpdates = Object.values(renderState).some(flag => flag) || Object.keys(updateMap).length > 0;
  if (!hasUpdates) {
    // Fallback to full render if no updates specified (safety net)
    console.warn('No render flags set, performing full render');
    markForUpdate(['step1', 'step2', 'step3']);
    renderState.suggestions = true;
  }
  render(updateMap);
}

/* ========= Row builders ========= */
function rowItem(t, opts){
  const li = document.createElement('li'); 
  li.dataset.id = t.id; 
  li.className = 'task' + ((opts && opts.showQuadrant && t.quadrant)? (' q-' + t.quadrant) : '');
  li.setAttribute('role', 'listitem');
  
  const cb = document.createElement('input'); 
  cb.type='checkbox'; 
  cb.id = `task-${t.id}`;
  cb.checked=t.completed; 
  cb.setAttribute('aria-describedby', `task-title-${t.id}`);
  cb.onchange = ()=>{ 
    t.completed = !t.completed; 
    t.updatedAt = Date.now(); 
    saveLocal(); 
    queueUpload(); 
    // Smart update: only update affected steps
    const updates = ['step3']; // Always update step3 (current list)
    if (!t.quadrant) updates.push('step1'); // Update step1 if in inbox
    if (t.quadrant) updates.push('step2'); // Update step2 if in quadrants
    markForUpdate(updates);
    render(); 
  };
  
  const title = document.createElement('div'); 
  title.className='title'; 
  title.id = `task-title-${t.id}`;
  title.textContent=t.title || ''; 
  if(t.completed){ title.className+=' strike'; }
  
  if(opts && opts.showQuadrant && t.quadrant){ 
    const pill = document.createElement('span'); 
    pill.className = 'qpill '+t.quadrant; 
    pill.textContent = t.quadrant;
    pill.setAttribute('aria-label', `Priority quadrant ${t.quadrant}`);
    title.appendChild(pill); 
  }
  
  const spacer = document.createElement('div'); spacer.className='spacer';
  
  const del = document.createElement('button'); 
  del.className='btn pill ghost closebtn'; 
  del.textContent='√ó'; 
  del.setAttribute('aria-label', `Delete task: ${t.title}`);
  del.title='Delete task';
  del.onclick = ()=> requestDelete(t, ()=>{ 
    tasks = tasks.filter(x=>x.id!==t.id); 
    saveLocal(); 
    queueUpload(); 
    __recordDelete(); 
    markForUpdate(['step1', 'step2', 'step3']); 
    render(); 
  });
  
  li.append(cb, title, spacer, del); 
  return li;
}

function mountQuadrantList(container, arr, key){
  if(!arr.length){ 
    const emptyLi = document.createElement('li');
    emptyLi.className = 'empty-state';
    emptyLi.setAttribute('role', 'listitem');
    emptyLi.style.padding = '20px';
    emptyLi.innerHTML = '<p style="font-size:13px;color:var(--muted)">No tasks in this quadrant</p>';
    container.innerHTML = '';
    container.appendChild(emptyLi);
    return; 
  }
  
  // Use document fragment for efficient DOM manipulation
  const fragment = document.createDocumentFragment();
  
  arr.forEach((t, idx)=>{
    const li = createQuadrantListItem(t, key);
    fragment.appendChild(li);
  });
  
  container.innerHTML = '';
  container.appendChild(fragment);
}

// Separate function for creating quadrant list items (better organization)
function createQuadrantListItem(t, key) {
  const li = document.createElement('li'); 
  li.className='task'; 
  li.dataset.id=t.id;
  li.setAttribute('role', 'listitem');
  
  const cb = document.createElement('input'); 
  cb.type='checkbox'; 
  cb.id = `task-${key}-${t.id}`;
  cb.checked=t.completed; 
  cb.setAttribute('aria-describedby', `task-title-${key}-${t.id}`);
  cb.onchange = ()=>{ 
    t.completed=!t.completed; 
    t.updatedAt=Date.now(); 
    saveLocal(); 
    queueUpload(); 
    markForUpdate(['step2', 'step3']);
    render(); 
  };
  
  const title = document.createElement('div'); 
  title.className='title'; 
  title.id = `task-title-${key}-${t.id}`;
  title.textContent=t.title || ''; 
  if(t.completed){ title.className+=' strike'; }
  
  const spacer = document.createElement('div'); spacer.className='spacer';
  
  const actions = document.createElement('div'); 
  actions.className='row-actions';
  actions.setAttribute('role', 'group');
  actions.setAttribute('aria-label', `Actions for ${t.title}`);
  
  const up = document.createElement('button'); 
  up.className='btn icon primary'; 
  up.setAttribute('aria-label', `Move ${t.title} up in priority`);
  up.title='Move up'; 
  up.innerHTML='<span aria-hidden="true">‚Üë</span>'; 
  up.onclick=()=>moveWithinQuadrant(t.id,key,-1);
  
  const down = document.createElement('button'); 
  down.className='btn icon primary'; 
  down.setAttribute('aria-label', `Move ${t.title} down in priority`);
  down.title='Move down'; 
  down.innerHTML='<span aria-hidden="true">‚Üì</span>'; 
  down.onclick=()=>moveWithinQuadrant(t.id,key,+1);
  
  const decat = document.createElement('button'); 
  decat.className='btn icon ghost'; 
  decat.setAttribute('aria-label', `Remove ${t.title} from category`);
  decat.title='De‚Äëcategorise'; 
  decat.innerHTML='<span aria-hidden="true">‚Ü©</span>'; 
  decat.onclick=()=>{ 
    t.quadrant=null; 
    t.rank=null; 
    t.updatedAt=Date.now(); 
    saveLocal(); 
    queueUpload(); 
    markForUpdate(['step1', 'step2', 'step3']);
    render(); 
  };
  
  const del = document.createElement('button'); 
  del.className='btn icon ghost closebtn'; 
  del.setAttribute('aria-label', `Delete task: ${t.title}`);
  del.title='Delete'; 
  del.textContent='√ó'; 
  del.onclick=()=> requestDelete(t, ()=>{ 
    tasks = tasks.filter(x=>x.id!==t.id); 
    saveLocal(); 
    queueUpload(); 
    __recordDelete(); 
    markForUpdate(['step1', 'step2', 'step3']);
    render(); 
  });
  
  actions.append(up,down,decat,del);
  li.append(cb,title,spacer,actions);
  return li;
}

/* ========= Settings modal ========= */
const modal = document.getElementById('settingsModal');
byId('settingsBtn').onclick = ()=> openSettings();
byId('closeSettings').onclick = ()=> closeSettings();
function openSettings(){ 
  modal.style.display='flex'; 
  modal.setAttribute('aria-hidden', 'false'); 
  loadSettingsIntoUI(); 
  buildSwatches(); 
  // Focus first focusable element 
  setTimeout(() => { 
    const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'); 
    if (firstFocusable) firstFocusable.focus(); 
  }, 100); 
}

function closeSettings(){ 
  modal.style.display='none'; 
  modal.setAttribute('aria-hidden', 'true'); 
  // Return focus to settings button 
  el.settingsBtn.focus(); 
}

/* ========= Error Handling & Notifications ========= */
let notificationTimeout = null;

function showNotification(message, type = 'info') {
  // Clear existing notification
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
  }
  
  // Remove existing notifications
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  
  // Create notification
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  notification.setAttribute('role', 'alert');
  notification.setAttribute('aria-live', 'polite');
  
  // Add styles for notification
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    background: type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#2563eb',
    color: 'white',
    padding: '12px 20px',
    borderRadius: '8px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    zIndex: '1000',
    maxWidth: '300px',
    fontSize: '14px',
    transform: 'translateX(100%)',
    transition: 'transform 0.3s ease'
  });
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 10);
  
  // Auto-hide after 4 seconds
  notificationTimeout = setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 4000);
}

function showError(message) {
  showNotification(message, 'error');
}

function showSuccess(message) {
  showNotification(message, 'success');
}

/* ========= Visual Feedback Helpers ========= */
function addSuccessFlash(element) {
  element.classList.add('success-flash');
  setTimeout(() => {
    element.classList.remove('success-flash');
  }, 600);
}

function addLoadingState(element) {
  element.classList.add('loading');
}

function removeLoadingState(element) {
  element.classList.remove('loading');
}

// Enhanced form submission with loading state
function submitWithFeedback(formElement, submitFunction) {
  addLoadingState(formElement);
  try {
    const result = submitFunction();
    if (result instanceof Promise) {
      return result.finally(() => removeLoadingState(formElement));
    } else {
      removeLoadingState(formElement);
      return result;
    }
  } catch (error) {
    removeLoadingState(formElement);
    throw error;
  }
}

function showInfo(message) {
  showNotification(message, 'info');
}

/* ========= Enhanced Confirmation Dialogs ========= */
function requestDelete(task, callback) {
  const confirmed = confirm(`Are you sure you want to delete "${task.title}"?\n\nThis action cannot be undone.`);
  if (confirmed) {
    try {
      callback();
      showSuccess('Task deleted successfully');
    } catch(error) {
      console.error('Error deleting task:', error);
      showError('Failed to delete task. Please try again.');
    }
  }
}

/* ========= Missing function declarations ========= */
function byId(id) { return document.getElementById(id); }
function escapeHtml(text) { 
  const div = document.createElement('div'); 
  div.textContent = text; 
  return div.innerHTML; 
}
function requestDelete(task, callback) {
  if (confirm(`Delete "${task.title}"?`)) {
    callback();
  }
}
function queueUpload() {
  // Placeholder for sync functionality
}
function __recordDelete() {
  // Placeholder for analytics
}
function loadSettingsIntoUI() {
  // Load settings into the UI when modal opens
  const syncSettings = JSON.parse(localStorage.getItem(SYNC_KEY) || '{}');
  if (el.firebaseConfig) el.firebaseConfig.value = syncSettings.firebaseConfig || '';
  if (el.roomCode) el.roomCode.value = syncSettings.roomCode || '';
  if (el.displayName) el.displayName.value = syncSettings.displayName || '';
  if (el.enableSync) el.enableSync.checked = syncSettings.enabled || false;
}

// Global error handler
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  showError('An unexpected error occurred. Please refresh the page if issues persist.');
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  showError('An unexpected error occurred. Please refresh the page if issues persist.');
});

// Initialize
try {
  initAccent();
  // Initial render with all sections
  markForUpdate(['step1', 'step2', 'step3']);
  renderState.suggestions = true;
  render();
  showInfo('Welcome to Covey To-Do!');
} catch(error) {
  console.error('Initialization error:', error);
  showError('Failed to initialize the application. Please refresh the page.');
}
</script>

</body>
</html>