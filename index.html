<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Covey To‑Do · Minimal + Sync (Accent) · v43</title>
<meta name="theme-color" content="#2563eb" id="themeColorMeta">
<style>
/*
  Covey To‑Do v43
  - Adds Firestore real-time sync (per‑user doc: users/{uid}/lists/default)
  - Fixes Firebase storageBucket domain (.appspot.com)
  - Keeps v36.2 UI: pill input, blue Add button, list layout in Step 2
*/

:root{
  --accent:#2563eb; /* primary */
  --bg:#f7f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
  --pill-bg:#f3f4f6; --pill-text:#374151; --shadow:0 1px 2px rgba(0,0,0,.05), 0 6px 16px rgba(0,0,0,.04);
  --btn-h:46px; --btn-radius:12px; --card-max:860px;
  --q1:#ef4444; --q2:#10b981; --q3:#f59e0b; --q4:#6366f1;
}
[data-theme="dark"]{
  --bg:#0b0c10; --card:#111317; --text:#f5f7fb; --muted:#9aa0a6; --border:#24272c;
  --pill-bg:#1b1e24; --pill-text:#cbd5e1; --shadow:0 1px 2px rgba(0,0,0,.6), 0 6px 18px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-family, Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif);background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:0 auto;padding:16px;text-align:center}
header{margin:6px 0 12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
h1{font-size:20px;margin:0}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:var(--card-max);margin:12px auto}

/* Buttons */
.btn{appearance:none;border:1px solid var(--border);background:var(--card);padding:0 18px;border-radius:var(--btn-radius);font-weight:600;cursor:pointer;color:var(--text);min-height:var(--btn-h);display:inline-flex;align-items:center;justify-content:center;transition:transform .07s ease,box-shadow .12s ease,background .12s ease,color .12s ease;font-family:inherit}
.btn:hover{box-shadow:0 2px 6px rgba(0,0,0,.08);transform:translateY(-1px)}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important}
.btn.ghost{background:var(--card);} 
.btn.pill{border-radius:999px}
.btn.sm{min-height:36px;padding:0 12px;font-weight:500;border-radius:10px}
.toggle{border-radius:999px;min-width:46px;min-height:46px;padding:0}

/* Stepper */
.btnrow{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;max-width:var(--card-max);margin:10px auto}
.btnrow>.btn{flex:1 1 0;max-width:240px}

/* Input row */
#addForm{display:grid;grid-template-columns:1fr auto;gap:12px}
input[type="text"],textarea{border:1px solid var(--border);border-radius:999px;padding:12px 16px;width:100%;background:var(--card);color:var(--text);font-family:inherit}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;max-width:var(--card-max);margin:12px auto 0}
.chip{border:1px solid var(--border);background:var(--card);border-radius:999px;font-size:13px;padding:10px 14px;cursor:pointer;color:var(--text);transition:transform .08s ease,box-shadow .12s ease;font-family:inherit}
.chip:hover{transform:translateY(-1px);box-shadow:0 1px 3px rgba(0,0,0,.12)}

/* Priority Rating Grid */
.priority-rating-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;max-width:800px;margin:0 auto 20px}
.priority-rating-btn{min-height:44px;font-weight:700;font-size:16px;flex:1;min-width:0}

/* Mobile responsive for priority rating */
@media (max-width: 768px) {
  .priority-rating-grid{grid-template-columns:repeat(5,1fr);max-width:400px}
}

@media (max-width: 480px) {
  .priority-rating-grid{grid-template-columns:repeat(5,1fr);max-width:300px;gap:6px}
  .priority-rating-btn{min-height:40px;font-size:14px}
}

/* Lists */
.list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;text-align:left}
.task{position:relative;display:flex;gap:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px;align-items:center;box-shadow:var(--shadow)}
.title{font-weight:600;white-space:normal;word-break:normal;overflow-wrap:anywhere;line-height:1.25}
.strike{text-decoration:line-through;opacity:.7}
.spacer{flex:1 1 auto}
.pill{font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--pill-bg);color:var(--pill-text)}
.closebtn{border-color:rgba(239,68,68,.4);color:#ef4444;background:transparent}
.closebtn:hover{background:rgba(239,68,68,.08)}

/* View transitions */
.view{max-height:0;opacity:0;transform:translateY(6px);overflow:hidden;transition:opacity .2s ease,transform .2s ease,max-height .25s ease}
.view.active{max-height:4000px;opacity:1;transform:none}

/* Quadrants */
.quads{display:grid;grid-template-columns:1fr;gap:12px;max-width:var(--card-max);margin:0 auto}
.quads .card{width:100%;max-width:100%;min-width:0}
.quads .card .sec-title{font-size:13.5px;letter-spacing:.06em;font-weight:800;padding:12px 14px;border-radius:10px;display:block;width:100%;margin-bottom:6px;background:var(--pill-bg);border:1px solid var(--border)}
.quads .card:nth-child(1) .sec-title{border-left:6px solid var(--q1);padding-left:10px}
.quads .card:nth-child(2) .sec-title{border-left:6px solid var(--q2);padding-left:10px}
.quads .card:nth-child(3) .sec-title{border-left:6px solid var(--q3);padding-left:10px}
.quads .card:nth-child(4) .sec-title{border-left:6px solid var(--q4);padding-left:10px}

/* Quadrant background tints */
.quads .card:nth-child(1){background:rgba(239,68,68,.08)}
.quads .card:nth-child(2){background:rgba(16,185,129,.08)}
.quads .card:nth-child(3){background:rgba(245,158,11,.08)}
.quads .card:nth-child(4){background:rgba(99,102,241,.08)}
.task.q-Q1{border-left:4px solid var(--q1);background:rgba(239,68,68,.08)}
.task.q-Q2{border-left:4px solid var(--q2);background:rgba(16,185,129,.08)}
.task.q-Q3{border-left:4px solid var(--q3);background:rgba(245,158,11,.08)}
.task.q-Q4{border-left:4px solid var(--q4);background:rgba(99,102,241,.08)}
.qpill{font-size:11px;border:1px solid var(--border);padding:3px 7px;border-radius:999px;background:var(--pill-bg);color:var(--pill-text);margin-left:8px;line-height:1}

/* Step 2 LIST layout controls */
.row-actions{display:flex;gap:8px;align-items:center}
.btn.icon{min-width:36px;min-height:36px;padding:0 0;border-radius:10px}
.btn.icon span{font-size:16px;line-height:1}

/* List-style item for categorize & prioritize */
.quadrant-task{padding:16px;border:none;border-radius:8px;background:transparent;margin-bottom:8px;border-bottom:1px solid rgba(0,0,0,.06);width:100%;max-width:100%;box-sizing:border-box;display:block}
.quadrant-task:last-child{border-bottom:none}
.quadrant-task .title{font-weight:500;font-size:15px;margin-bottom:8px;width:100%}
.quadrant-task .row-actions{width:100%;justify-content:flex-start;flex-wrap:wrap;gap:6px}
.quadrant-task .row-actions .btn{font-size:13px;padding:6px 12px;min-height:32px;flex:none}
.quadrant-task .row-actions .btn.primary{background:var(--accent);color:white;border:none}

/* Accessible checkboxes */
input[type="checkbox"]{-webkit-appearance:none;appearance:none;width:18px;height:18px;margin:0 8px 0 0;border-radius:6px;border:2px solid var(--muted);background:var(--pill-bg);display:inline-grid;place-content:center;transition:background .12s ease,border-color .12s ease,box-shadow .12s ease,transform .05s ease}
input[type="checkbox"]:hover{transform:translateY(-1px)}
input[type="checkbox"]:focus{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.35)}
input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
input[type="checkbox"]:checked::after{content:"";width:10px;height:6px;border:2px solid #fff;border-top:0;border-left:0;transform:translateY(-1px) rotate(45deg)}

/* Responsive */
@media (max-width:560px){
  .btnrow>.btn{max-width:100%}
  .container{padding:12px}
  h1{font-size:18px}
  .quads{grid-template-columns:1fr;gap:8px}
  .task{padding:10px;gap:8px}
  .btn.icon{min-width:32px;min-height:32px}
  #addForm{grid-template-columns:1fr;gap:8px}
  #addForm button{justify-self:stretch}
  .quadrant-task{padding:12px}
  
  /* Better mobile header layout */
  header{flex-direction:column;gap:8px;margin:8px 0 12px}
  header > div:first-child{flex:none;justify-content:center}
  header h1{order:1}
  header .row{order:3;flex:none;justify-content:center!important;flex-wrap:wrap;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
  #authStatus{font-size:12px;padding:6px 10px}
  
  /* Move auth controls below navigation */
  #stepper{order:2;margin-bottom:16px}
  
  /* Prevent iOS zoom on input focus by ensuring 16px minimum font size */
  input[type="text"],
  input[type="email"], 
  input[type="password"],
  textarea {
    font-size: 16px !important;
  }
}

/* Loading + notifications */
.loading {opacity:.6;pointer-events:none;position:relative}
.loading::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid var(--muted);border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.chip:hover,.task:hover{border-color:var(--accent);box-shadow:0 2px 8px rgba(37,99,235,.15)}
.btn:focus-visible,input:focus-visible,textarea:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.task{transition:all .2s ease}
.task:hover{transform:translateY(-1px)}
.view{transition:opacity .3s ease, transform .3s ease, max-height .4s ease}
.success-flash{animation:successFlash .6s ease}
@keyframes successFlash{0%{background:var(--card)}50%{background:rgba(16,185,129,.1)}100%{background:var(--card)}}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state::before{content:'📝';font-size:48px;display:block;margin-bottom:16px;opacity:.5}
@media (min-width:1200px){.container{max-width:1100px}.card{padding:20px}.quads{gap:16px}}
</style>
</head>
<body>
<div class="container" id="root">
  <header>
    <div style="flex: 1; display: flex; justify-content: flex-start;">
      <button id="themeToggle" class="btn pill ghost toggle" aria-label="Toggle theme" style="min-height:36px">🌓</button>
    </div>
    <h1 style="margin:0; flex: 0 0 auto;">Covey To‑Do</h1>
    <div class="row" style="flex: 1; justify-content:flex-end; gap:12px">
      <span id="authStatus" class="pill" style="min-height:36px;font-weight:600;padding:8px 14px;font-size:13px;display:inline-flex;align-items:center">Signed out</span>
      <button id="signInBtn" class="btn pill primary" aria-haspopup="dialog" aria-controls="signInModal" style="font-weight:700;min-height:36px">Sign in</button>
      <button id="settingsBtn" class="btn pill ghost" aria-haspopup="dialog" aria-controls="settingsModal" style="min-height:36px">⚙︎</button>
    </div>
  </header>

  <!-- Stepper -->
  <nav class="btnrow" id="stepper" role="tablist" aria-label="Todo app steps">
    <button id="step1Btn" class="btn pill primary" role="tab" aria-selected="true" aria-controls="step1" tabindex="0">1. Add</button>
    <button id="step2Btn" class="btn pill ghost" role="tab" aria-selected="false" aria-controls="step2" tabindex="-1">2. Categorise</button>
    <button id="step3Btn" class="btn pill ghost" role="tab" aria-selected="false" aria-controls="step3" tabindex="-1">3. Prioritise & Manage</button>
    <button id="step4Btn" class="btn pill ghost" role="tab" aria-selected="false" aria-controls="step4" tabindex="-1">4. Visualize</button>
  </nav>

  <!-- Step 1: Add -->
  <section id="step1" class="view active" role="tabpanel" aria-labelledby="step1Btn" aria-hidden="false">
    <div class="card">
      <form id="addForm" aria-label="Add new task">
        <input id="taskInput" type="text" placeholder="Add a task…" aria-label="Task description" required maxlength="200" autocomplete="off" />
        <button type="submit" class="btn pill primary" aria-label="Add task">Add Task</button>
      </form>
      <div id="suggestions" class="chips" role="group" aria-label="Task suggestions"></div>
    </div>
    <div class="card">
      <ul id="inboxList" class="list" role="list" aria-label="Uncategorized tasks"></ul>
    </div>
  </section>

  <!-- Step 2: Categorise -->
  <section id="step2" class="view" role="tabpanel" aria-labelledby="step2Btn" aria-hidden="true">
    <div class="card">
      <p style="color:var(--muted);font-size:14px;margin:0 0 16px;text-align:center">Assign tasks to quadrants based on urgency and importance</p>
      <div id="categoriseBox"></div>
    </div>
    <div class="quads" role="region" aria-label="Eisenhower Matrix - Task Quadrants">
      <div class="card">
        <h3 class="sec-title" id="q1-title">Q1 · Urgent + Important</h3>
        <ul id="listQ1" class="list" role="list" aria-labelledby="q1-title"></ul>
      </div>
      <div class="card">
        <h3 class="sec-title" id="q2-title">Q2 · Not Urgent + Important</h3>
        <ul id="listQ2" class="list" role="list" aria-labelledby="q2-title"></ul>
      </div>
      <div class="card">
        <h3 class="sec-title" id="q3-title">Q3 · Urgent + Not Important</h3>
        <ul id="listQ3" class="list" role="list" aria-labelledby="q3-title"></ul>
      </div>
      <div class="card">
        <h3 class="sec-title" id="q4-title">Q4 · Not Urgent + Not Important</h3>
        <ul id="listQ4" class="list" role="list" aria-labelledby="q4-title"></ul>
      </div>
    </div>
  </section>

  <!-- Step 3: Prioritise & Manage -->
  <section id="step3" class="view" role="tabpanel" aria-labelledby="step3Btn" aria-hidden="true">
    <div class="card">
      <div class="sec-title">Prioritise & Manage Tasks</div>
      <p style="color:var(--muted);font-size:14px;margin:0 0 16px;text-align:center">Rate each task's urgency and importance (1-10) to calculate priority weighting</p>
      <div class="btnrow" style="margin-bottom:16px">
        <label class="btn pill ghost" style="gap:8px; min-height:36px; min-width:auto">
          <input id="showCompleted" type="checkbox" style="accent-color:var(--accent)"> Show completed
        </label>
        <button id="clearBtn" class="btn pill ghost" aria-label="Clear all tasks">Clear all</button>
      </div>
      <div id="prioritiseBox"></div>
    </div>
  </section>

  <!-- Step 4: Visualize -->
  <section id="step4" class="view" role="tabpanel" aria-labelledby="step4Btn" aria-hidden="true">
    <div class="card">
      <p style="color:var(--muted);font-size:14px;margin:0 0 16px;text-align:center">Visual mind map of your tasks sized by priority</p>
      
      <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
          <input type="checkbox" id="showCompletedMindMap" style="accent-color: var(--accent);">
          Show completed tasks
        </label>
      </div>
      
      <div id="mindMapContainer" style="width: 100%; height: 500px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); position: relative; overflow: hidden;">
        <svg id="mindMapSvg" width="100%" height="100%" viewBox="0 0 800 500" style="display: block;">
          <!-- Mind map will be rendered here -->
        </svg>
      </div>
      
      <div style="text-align: center; margin-top: 12px; font-size: 12px; color: var(--muted);">
        Node size represents priority (urgency × importance). Click nodes to view details.
      </div>
    </div>
  </section>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Settings" style="position:fixed;inset:0;background:rgba(0,0,0,.15);display:none;align-items:center;justify-content:center;padding:16px">
  <div class="sheet" style="background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:560px;width:100%;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.12);text-align:left">
    <div class="row" style="justify-content:center; gap:12px; margin-bottom:6px; display:flex; align-items:center">
      <h2 style="margin:0;font-size:16px; text-align:center; flex:1">Settings</h2>
      <button id="closeSettings" class="btn pill ghost" aria-label="Close settings">✕</button>
    </div>

    <div style="margin-top:16px">
      <div class="sec-title">Font</div>
      <select id="fontSelect" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);font-size:14px;margin-top:8px">
        <option value="system-ui, -apple-system, 'Segoe UI', Roboto, Inter, Arial, sans-serif">System Default</option>
        <option value="Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">Inter</option>
        <option value="'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif">SF Pro Display</option>
        <option value="'Segoe UI Variable', 'Segoe UI', system-ui, sans-serif">Segoe UI</option>
        <option value="Roboto, 'Helvetica Neue', Arial, sans-serif">Roboto</option>
        <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
        <option value="'JetBrains Mono', 'Fira Code', Consolas, monospace">Monospace</option>
      </select>
    </div>

    <div style="margin-top:16px">
      <div class="sec-title">Preferences</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <label class="row" style="gap:8px; display:flex; align-items:center">
          <input id="confirmDeletes" type="checkbox" checked> 
          Confirm task deletions
        </label>
        <label class="row" style="gap:8px; display:flex; align-items:center">
          <input id="enableAnimations" type="checkbox" checked> 
          Enable animations
        </label>
        <label class="row" style="gap:8px; display:flex; align-items:center">
          <input id="autoFocusInput" type="checkbox" checked> 
          Auto-focus task input
        </label>
      </div>
    </div>

    <div style="margin-top:16px">
      <div class="sec-title">Data</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="exportData" class="btn pill ghost">Export tasks</button>
        <button id="importData" class="btn pill ghost">Import tasks</button>
        <input id="importFile" type="file" accept=".json" style="display:none">
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

    <div>
      <div class="sec-title">Accent colour</div>
      <div class="swatches" id="accentSwatches" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px"></div>
      <div class="colorrow" style="display:flex;align-items:center;gap:10px;margin-top:8px">
        <input type="color" id="accentCustom" value="#2563eb" />
        <button id="accentApply" class="btn pill ghost">Apply custom</button>
      </div>
    </div>

    <div class="btnrow" style="margin-top:16px">
      <button id="saveSettings" class="btn pill primary">Save</button>
    </div>
  </div>
</div>

<!-- Sign In Modal -->
<div id="signInModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Sign In" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px">
  <div class="sign-in-sheet" style="background:#1e293b;border:1px solid #334155;border-radius:12px;max-width:400px;width:100%;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,.4);text-align:left;color:#f1f5f9">
    <div class="row" style="justify-content:space-between; margin-bottom:20px; display:flex; align-items:center">
      <h2 style="margin:0;font-size:18px;font-weight:600;color:#f1f5f9">Sign in</h2>
      <button id="closeSignIn" class="btn pill ghost" aria-label="Close sign in" style="background:transparent;border:1px solid #475569;color:#94a3b8">✕</button>
    </div>

    <form id="signInForm" style="display:flex;flex-direction:column;gap:16px">
      <div>
        <input id="emailInput" type="email" placeholder="Email" aria-label="Email address" required style="width:100%;padding:12px 16px;border:1px solid #475569;border-radius:8px;background:#334155;color:#f1f5f9;font-size:14px" />
      </div>
      <div>
        <input id="passwordInput" type="password" placeholder="Password" aria-label="Password" required style="width:100%;padding:12px 16px;border:1px solid #475569;border-radius:8px;background:#334155;color:#f1f5f9;font-size:14px" />
      </div>

      <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
        <button type="submit" class="btn pill primary" style="flex:1;min-width:100px">Sign in</button>
        <button type="button" id="createAccountBtn" class="btn pill ghost" style="flex:1;min-width:100px;background:#374151;border:1px solid #4b5563;color:#f3f4f6">Create account</button>
      </div>

      <button type="button" id="googleSignInBtn" class="btn pill ghost" style="width:100%;background:#374151;border:1px solid #4b5563;color:#f3f4f6;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:4px">
        <svg width="18" height="18" viewBox="0 0 24 24" style="fill:currentColor">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Continue with Google
      </button>
    </form>

    <div id="authStatusModal" style="margin-top:16px;text-align:center;font-size:12px;color:#94a3b8">Idle</div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js" defer></script>

<script>
/* ========= Theme ========= */
const THEME_KEY = "covey_theme_pref";
const ACCENT_KEY = "covey_accent_pref";
function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); }
function systemPrefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
function initTheme(){ const saved = localStorage.getItem(THEME_KEY); const t = saved || (systemPrefersDark() ? 'dark' : 'light'); applyTheme(t); }
function toggleTheme(){ const cur = document.documentElement.getAttribute('data-theme') || 'light'; const next = cur === 'dark' ? 'light' : 'dark'; applyTheme(next); localStorage.setItem(THEME_KEY, next); }
initTheme();

/* ========= Accent ========= */
const themeMeta = document.getElementById('themeColorMeta');
function applyAccent(hex){ document.documentElement.style.setProperty('--accent', hex); if(themeMeta) themeMeta.setAttribute('content', hex); localStorage.setItem(ACCENT_KEY, hex); }
function initAccent(){ const saved = localStorage.getItem(ACCENT_KEY); if(saved){ applyAccent(saved); } }

/* ========= Local state ========= */
const STORAGE_KEY = "covey_minimal_v4";
const SYNC_KEY = "covey_sync_settings_v1";
let tasks = loadLocal();
let step = 1;
let answeredUrgent = null;
let showCompleted = false;

// Sync helpers
let db = null;
let unsubscribe = null;
let lastPushedAt = 0;

// Performance render flags
let renderState = { step1:true, step2:true, step3:true, step4:true, suggestions:true };

function debounce(func, wait){ let timeout; return function(...args){ clearTimeout(timeout); timeout=setTimeout(()=>func.apply(this,args), wait); }; }

function loadLocal(){ try{ const data = localStorage.getItem(STORAGE_KEY); if(!data) return []; const parsed = JSON.parse(data); if(!Array.isArray(parsed)) return []; return parsed.map(task => ({ ...task, duration: task.duration || null, targetDate: task.targetDate !== undefined ? task.targetDate : null })); }catch(e){ console.error('Failed to load from localStorage:', e); return []; } }
function saveLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }catch(e){ console.error('Failed to save to localStorage:', e); }}
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function nowMs(){ return Date.now(); }
function num(v){ return (v===undefined||v===null)? Number.POSITIVE_INFINITY : Number(v); }

/* ========= Derived helpers ========= */
function inbox(includeCompleted){ return tasks.filter(t=>!t.quadrant && (includeCompleted || !t.completed)); }
function groups(includeCompleted){ const g={Q1:[],Q2:[],Q3:[],Q4:[]}; tasks.forEach(t=>{ if(t.quadrant && (includeCompleted || !t.completed)) g[t.quadrant].push(t); }); for(const q of ['Q1','Q2','Q3','Q4']) g[q].sort((a,b)=> (num(a.rank)-num(b.rank)) || (a.createdAt-b.createdAt)); return g; }
function allSorted(includeCompleted){ const g=groups(includeCompleted); return [...g.Q1,...g.Q2,...g.Q3,...g.Q4]; }

/* ========= DOM refs ========= */
let el = {};

// Initialize DOM references when page loads
document.addEventListener('DOMContentLoaded', function() {
  el = { step1:byId('step1'), step2:byId('step2'), step3:byId('step3'), step4:byId('step4'),
    step1Btn:byId('step1Btn'), step2Btn:byId('step2Btn'), step3Btn:byId('step3Btn'), step4Btn:byId('step4Btn'),
    addForm:byId('addForm'), taskInput:byId('taskInput'), inboxList:byId('inboxList'),
    listQ1:byId('listQ1'), listQ2:byId('listQ2'), listQ3:byId('listQ3'), listQ4:byId('listQ4'),
    categoriseBox:byId('categoriseBox'), prioritiseBox:byId('prioritiseBox'), suggestions:byId('suggestions'),
    mindMapSvg:byId('mindMapSvg'), showCompletedMindMap:byId('showCompletedMindMap'),
    showCompleted:byId('showCompleted'), clearBtn:byId('clearBtn'),
    settingsBtn:byId('settingsBtn'), settingsModal:byId('settingsModal'), closeSettings:byId('closeSettings'),
    signInBtn:byId('signInBtn'), signInModal:byId('signInModal'), closeSignIn:byId('closeSignIn'),
    signInForm:byId('signInForm'), emailInput:byId('emailInput'), passwordInput:byId('passwordInput'),
    createAccountBtn:byId('createAccountBtn'), googleSignInBtn:byId('googleSignInBtn'), authStatus:byId('authStatus'), authStatusModal:byId('authStatusModal'),
    saveSettings:byId('saveSettings'), accentSwatches:byId('accentSwatches'), accentCustom:byId('accentCustom'), accentApply:byId('accentApply'),
    fontSelect:byId('fontSelect'), confirmDeletes:byId('confirmDeletes'), enableAnimations:byId('enableAnimations'), autoFocusInput:byId('autoFocusInput'),
    exportData:byId('exportData'), importData:byId('importData'), importFile:byId('importFile') };
  
  // Set up event listeners
  byId('themeToggle').onclick = toggleTheme;
  
  // Initialize step navigation
  el.step1Btn.onclick=()=> setStep(1);
  el.step2Btn.onclick=()=> setStep(2);
  el.step3Btn.onclick=()=> setStep(3);
  el.step4Btn.onclick=()=> setStep(4);
  
  // Initialize other event handlers that depend on DOM elements
  initializeEventHandlers();
  
  // Check for missing critical elements
  const critical = ['step1', 'step2', 'step3', 'step4', 'prioritiseBox', 'categoriseBox', 'addForm', 'taskInput', 'inboxList', 'mindMapSvg'];
  const missing = critical.filter(key => !el[key]);
  if (missing.length > 0) {
    console.error('Missing critical DOM elements:', missing);
  }
  
  // Initialize Firebase if available  
  if(typeof firebase !== 'undefined'){ 
    initializeFirebase(); 
  } else { 
    window.addEventListener('load', ()=>{ 
      setTimeout(()=>{ 
        if(typeof firebase!=='undefined'){ 
          initializeFirebase(); 
        } 
      },100); 
    }); 
  }
  
  // Initial render
  markForUpdate(['step1','step2','step3','step4']);
  renderState.suggestions=true;
  render();
  
  // Welcome message
  showInfo('Welcome to Covey To-Do!');
});

/* ========= Keyboard Navigation ========= */
document.addEventListener('keydown', (e)=>{
  if(e.target.closest('#stepper')){
    const buttons=[el.step1Btn,el.step2Btn,el.step3Btn,el.step4Btn];
    const idx=buttons.findIndex(btn=>btn===e.target);
    if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
      e.preventDefault();
      const dir=e.key==='ArrowLeft'? -1 : 1;
      const ni=(idx+dir+buttons.length)%buttons.length;
      buttons[ni].focus(); setStep(ni+1);
    } else if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setStep(idx+1); }
  }
  if(e.key==='Escape' && el.settingsModal.style.display==='flex'){ closeSettings(); }
  if(el.settingsModal.style.display==='flex' && e.key==='Tab'){ trapFocus(e, el.settingsModal); }
  if(el.signInModal.style.display==='flex' && e.key==='Tab'){ trapFocus(e, el.signInModal); }
  if(e.key==='Escape' && el.signInModal.style.display==='flex'){ closeSignIn(); }
});
function trapFocus(e, container){ const f=container.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'); const first=f[0], last=f[f.length-1]; if(e.shiftKey){ if(document.activeElement===first){ last.focus(); e.preventDefault(); } } else { if(document.activeElement===last){ first.focus(); e.preventDefault(); } } }

/* ========= Accent UI ========= */
const PRESET_ACCENTS=["#2563eb","#7c3aed","#db2777","#ef4444","#059669","#0ea5e9","#f59e0b","#111827"];
function buildSwatches(){ el.accentSwatches.innerHTML=''; PRESET_ACCENTS.forEach(hex=>{ const b=document.createElement('button'); b.className='chip'; b.style.borderRadius='999px'; b.style.background=hex; b.style.color='#fff'; b.style.border='1px solid var(--border)'; b.style.minWidth='36px'; b.style.height='28px'; b.title=hex; b.type='button'; b.onclick=()=>{ applyAccent(hex); buildSwatches(); }; el.accentSwatches.appendChild(b); }); }


/* ========= Step nav ========= */
function setStep(n){ if(step===n) return; step=n; const secs=[el.step1,el.step2,el.step3,el.step4]; const btns=[el.step1Btn,el.step2Btn,el.step3Btn,el.step4Btn]; secs.forEach((sec,i)=>{ if(i===n-1){ sec.classList.add('active'); sec.setAttribute('aria-hidden','false'); } else { sec.classList.remove('active'); sec.setAttribute('aria-hidden','true'); } }); btns.forEach((b,i)=>{ if(i===n-1){ b.className='btn pill primary'; b.setAttribute('aria-selected','true'); b.setAttribute('tabindex','0'); } else { b.className='btn pill ghost'; b.setAttribute('aria-selected','false'); b.setAttribute('tabindex','-1'); } }); const update={}; update[`step${n}`]=true; render(update); }

/* ========= Event Handlers Initialization ========= */
function initializeEventHandlers() {
  // Add form
  if (el.addForm) {
    el.addForm.onsubmit=(e)=>{ e.preventDefault(); const v=el.taskInput.value.trim(); if(!v){ showError('Please enter a task description'); el.taskInput.focus(); return; } if(v.length>200){ showError('Task description must be less than 200 characters'); el.taskInput.focus(); return; } if(tasks.some(t=> (t.title||'').toLowerCase()===v.toLowerCase())){ showError('A task with this description already exists'); el.taskInput.focus(); return; }
      addLoadingState(el.addForm); try{ tasks.unshift({id:uid(), title:v, completed:false, quadrant:null, rank:null, urgency:5, importance:5, duration:null, targetDate:null, createdAt:nowMs(), updatedAt:nowMs()}); el.taskInput.value=''; saveLocal(); queueUpload(); markForUpdate(['step1']); renderState.suggestions=true; render(); removeLoadingState(el.addForm); addSuccessFlash(el.inboxList); showSuccess('Task added successfully'); setTimeout(()=> el.taskInput.focus(),100); }catch(err){ removeLoadingState(el.addForm); console.error(err); showError('Failed to add task.'); }
    };
  }
  
  const debouncedSuggestionUpdate = debounce(()=>{ if(step===1){ renderState.suggestions=true; render({suggestions:true}); } }, 300);
  if (el.taskInput) {
    el.taskInput.addEventListener('input', debouncedSuggestionUpdate);
  } else {
    console.error('taskInput element not found - cannot add event listener');
  }
  
  // Accent controls
  
  
  // Settings
  if (el.settingsBtn) el.settingsBtn.onclick=()=> openSettings();
  if (el.closeSettings) el.closeSettings.onclick=()=> closeSettings();
  
  // Authentication
  if (el.signInBtn) el.signInBtn.onclick=()=> openSignIn();
  if (el.closeSignIn) el.closeSignIn.onclick=()=> closeSignIn();
  
  // Font selection
  if (el.fontSelect) el.fontSelect.onchange = () => applyFont(el.fontSelect.value);
  
  // Current list controls
  if (el.showCompleted) el.showCompleted.onchange=()=>{ showCompleted=el.showCompleted.checked; markForUpdate(['step3']); render(); };
  if (el.clearBtn) el.clearBtn.onclick=()=>{ const n=tasks.length; if(n===0){ showInfo('No tasks to clear'); return; } if(confirm(`Delete all ${n} tasks? This cannot be undone.`)){ addLoadingState(el.clearBtn); try{ tasks=[]; saveLocal(); queueUpload(true); markForUpdate(['step1','step2','step3']); renderState.suggestions=true; render(); showSuccess(`Cleared ${n} tasks`); } finally { removeLoadingState(el.clearBtn); } } };
  
  // Mind map controls
  if (el.showCompletedMindMap) el.showCompletedMindMap.onchange=()=>{ markForUpdate(['step4']); render(); };
  
  // Import/Export
  if (el.exportData) el.exportData.onclick=()=> exportTasks();
  if (el.importData) el.importData.onclick=()=> el.importFile.click();
  if (el.importFile) el.importFile.onchange=(e)=> importTasks(e.target.files[0]);
  
  // Sign in form
  if (el.signInForm) el.signInForm.onsubmit=(e)=>{ e.preventDefault(); if(!isFirebaseReady()){ showError('Cloud sync not configured - sign in disabled'); return; } const email=el.emailInput.value.trim(); const password=el.passwordInput.value; if(!email||!password){ showError('Enter email and password'); return; } signInWithEmail(email,password); };
  if (el.createAccountBtn) el.createAccountBtn.onclick=()=>{ if(!isFirebaseReady()){ showError('Cloud sync not configured - account creation disabled'); return; } const email=el.emailInput.value.trim(); const password=el.passwordInput.value; if(!email||!password){ showError('Enter email and password'); return; } if(password.length<6){ showError('Password must be at least 6 characters'); return; } createAccount(email,password); };
  if (el.googleSignInBtn) el.googleSignInBtn.onclick=()=>{ if(!isFirebaseReady()){ showError('Cloud sync not configured - Google sign in disabled'); return; } signInWithGoogle(); };
}


/* ========= Suggestions ========= */
function computeSuggestions(){ try{ const verbs=new Map(); for(const t of tasks){ const title=t.title||''; const w=title.split(/\s+/)[0]?.toLowerCase()||''; if(!w) continue; verbs.set(w,(verbs.get(w)||0)+1); } const common=Array.from(verbs.entries()).sort((a,b)=>b[1]-a[1]).map(([w])=>w).filter(w=>w.length>2); const base=["Plan","Book","Email","Call","Review","Draft","Schedule","Organise"]; const pool=[...new Set([...common,...base])].slice(0,8); return pool.map(v=> v.charAt(0).toUpperCase()+v.slice(1)+' …'); }catch(e){ return ["Plan …","Email …","Call …","Review …"]; } }
function applySuggestion(s){ const txt = s.endsWith(' …')? s.slice(0,-2)+' ' : s+' '; el.taskInput.value=txt; el.taskInput.focus(); el.taskInput.setSelectionRange(txt.length, txt.length); }

/* ========= Categorise flow ========= */
function answerUrgent(val){ answeredUrgent=val; markForUpdate(['step2']); render(); }
function answerImportant(val){ const current=inbox(false)[0]; if(!current) return; const urgent=!!answeredUrgent; const q = urgent ? (val? 'Q1':'Q3') : (val? 'Q2':'Q4'); const maxRank=Math.max(-1,...tasks.filter(t=>t.quadrant===q && t.rank!=null).map(t=>t.rank)); current.quadrant=q; current.rank=maxRank+1; current.updatedAt=nowMs(); saveLocal(); queueUpload(); answeredUrgent=null; markForUpdate(['step1','step2','step3']); render(); }

/* ========= Prioritise ========= */
function moveWithinQuadrant(id,qKey,delta){ const q=tasks.filter(t=>t.quadrant===qKey).sort((a,b)=> (num(a.rank)-num(b.rank)) || (a.createdAt-b.createdAt)); const i=q.findIndex(x=>x.id===id); if(i<0) return; const tgt=i+delta; if(tgt<0||tgt>=q.length) return; const a=q[i], b=q[tgt]; const tmp=a.rank; a.rank=b.rank; b.rank=tmp; normalizeRanks(qKey); saveLocal(); queueUpload(); markForUpdate(['step2','step3']); render(); }
function normalizeRanks(qKey){ const q=tasks.filter(t=>t.quadrant===qKey).sort((a,b)=> (num(a.rank)-num(b.rank)) || (a.createdAt-b.createdAt)); q.forEach((t,i)=>{ t.rank=i; t.updatedAt=nowMs(); }); }

/* ========= Render ========= */
function render(forceUpdate={}){ 
  const should={...renderState,...forceUpdate}; 
  if(should.step1){ renderStep1(); renderState.step1=false; renderState.suggestions=false; } 
  if(should.step2){ renderStep2(); renderState.step2=false; } 
  if(should.step3){ renderStep3(); renderState.step3=false; } 
  if(should.step4){ renderStep4(); renderState.step4=false; } 
  if(should.suggestions && !should.step1){ renderSuggestions(); renderState.suggestions=false; } 
}
function renderStep1(){ const unc=inbox(false); updateList(el.inboxList, unc, {showQuadrant:false}, 'No tasks'); renderSuggestions(); }
function renderStep2(){ const g=groups(true); const current=inbox(false)[0]; updateCategoriseBox(current); mountQuadrantList(el.listQ1,g.Q1,'Q1'); mountQuadrantList(el.listQ2,g.Q2,'Q2'); mountQuadrantList(el.listQ3,g.Q3,'Q3'); mountQuadrantList(el.listQ4,g.Q4,'Q4'); }
function renderStep3(){ renderPrioritise(); }
function renderStep4(){ renderMindMap(); }

/* ========= Mind Map Visualization ========= */
function renderMindMap() {
  if (!el.mindMapSvg) return;
  
  // Get tasks to display
  const showCompleted = el.showCompletedMindMap?.checked || false;
  const visibleTasks = tasks.filter(t => t.quadrant && (showCompleted || !t.completed));
  
  // Clear existing content
  el.mindMapSvg.innerHTML = '';
  
  if (visibleTasks.length === 0) {
    // Show empty state
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', '400');
    text.setAttribute('y', '250');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', 'var(--muted)');
    text.setAttribute('font-size', '14');
    text.textContent = 'No categorized tasks to visualize';
    el.mindMapSvg.appendChild(text);
    return;
  }
  
  // Calculate node data
  const nodes = visibleTasks.map(task => {
    const priority = calculatePriority(task);
    const normalizedScore = Math.max(1, Math.min(100, priority));
    const radius = Math.max(12, Math.min(44, 12 + (normalizedScore / 100) * 32));
    
    return {
      task,
      priority,
      radius,
      x: 0, // Will be calculated
      y: 0, // Will be calculated
      quadrant: task.quadrant
    };
  });
  
  // Position nodes by quadrant
  positionMindMapNodes(nodes);
  
  // Create SVG elements
  nodes.forEach((node, index) => {
    createMindMapNode(node, index);
  });
  
  // Add center label
  const centerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  centerText.setAttribute('x', '400');
  centerText.setAttribute('y', '250');
  centerText.setAttribute('text-anchor', 'middle');
  centerText.setAttribute('fill', 'var(--text)');
  centerText.setAttribute('font-size', '16');
  centerText.setAttribute('font-weight', '600');
  centerText.textContent = 'My Tasks';
  el.mindMapSvg.appendChild(centerText);
}

function positionMindMapNodes(nodes) {
  // Define quadrant sectors (angles in radians)
  const sectors = {
    Q1: { startAngle: 0, endAngle: Math.PI / 2, centerX: 550, centerY: 150 },      // Top-right
    Q2: { startAngle: Math.PI / 2, endAngle: Math.PI, centerX: 250, centerY: 150 }, // Top-left  
    Q3: { startAngle: Math.PI, endAngle: 3 * Math.PI / 2, centerX: 250, centerY: 350 }, // Bottom-left
    Q4: { startAngle: 3 * Math.PI / 2, endAngle: 2 * Math.PI, centerX: 550, centerY: 350 } // Bottom-right
  };
  
  // Group nodes by quadrant
  const quadrantGroups = { Q1: [], Q2: [], Q3: [], Q4: [] };
  nodes.forEach(node => {
    if (quadrantGroups[node.quadrant]) {
      quadrantGroups[node.quadrant].push(node);
    }
  });
  
  // Position each quadrant
  Object.keys(quadrantGroups).forEach(quadrant => {
    const group = quadrantGroups[quadrant];
    const sector = sectors[quadrant];
    
    if (group.length === 0) return;
    
    group.forEach((node, index) => {
      // Calculate position in circular arrangement
      const radius = 80 + (node.priority / 100) * 60; // Distance from sector center
      const angleStep = (sector.endAngle - sector.startAngle) / Math.max(1, group.length - 1);
      const angle = group.length === 1 
        ? (sector.startAngle + sector.endAngle) / 2  // Center if only one
        : sector.startAngle + (index * angleStep);
      
      node.x = sector.centerX + radius * Math.cos(angle);
      node.y = sector.centerY + radius * Math.sin(angle);
      
      // Keep nodes within bounds
      node.x = Math.max(node.radius + 10, Math.min(790 - node.radius, node.x));
      node.y = Math.max(node.radius + 10, Math.min(490 - node.radius, node.y));
    });
  });
}

function createMindMapNode(node, index) {
  const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  group.setAttribute('class', 'mind-map-node');
  group.setAttribute('data-task-id', node.task.id);
  group.setAttribute('tabindex', '0');
  
  // Create circle
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', node.x);
  circle.setAttribute('cy', node.y);
  circle.setAttribute('r', node.radius);
  circle.setAttribute('fill', getQuadrantColor(node.quadrant));
  circle.setAttribute('stroke', 'var(--border)');
  circle.setAttribute('stroke-width', '2');
  circle.setAttribute('opacity', node.task.completed ? '0.5' : '1');
  
  // Create label
  const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  text.setAttribute('x', node.x);
  text.setAttribute('y', node.y + 4);
  text.setAttribute('text-anchor', 'middle');
  text.setAttribute('fill', 'white');
  text.setAttribute('font-size', Math.min(12, node.radius / 2));
  text.setAttribute('font-weight', '600');
  text.setAttribute('pointer-events', 'none');
  
  // Truncate long titles
  const title = node.task.title || '';
  const maxLength = Math.max(3, Math.floor(node.radius / 3));
  text.textContent = title.length > maxLength ? title.substring(0, maxLength) + '…' : title;
  
  // Add tooltip
  const title_element = document.createElementNS('http://www.w3.org/2000/svg', 'title');
  title_element.textContent = `${node.task.title} (Priority: ${node.priority}/100, Urgency: ${node.task.urgency || 5}, Importance: ${node.task.importance || 5})`;
  
  // Add interactivity
  group.addEventListener('click', () => {
    // Switch to step 3 and highlight this task
    setStep(3);
    showInfo(`Viewing details for: ${node.task.title}`);
  });
  
  group.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      setStep(3);
      showInfo(`Viewing details for: ${node.task.title}`);
    }
  });
  
  group.appendChild(circle);
  group.appendChild(text);
  group.appendChild(title_element);
  el.mindMapSvg.appendChild(group);
}

function getQuadrantColor(quadrant) {
  const colors = {
    Q1: '#ef4444', // Red - Urgent + Important
    Q2: '#10b981', // Green - Not Urgent + Important  
    Q3: '#f59e0b', // Orange - Urgent + Not Important
    Q4: '#6b7280'  // Gray - Not Urgent + Not Important
  };
  return colors[quadrant] || '#6b7280';
}

// Priority calculation and sorting
function calculatePriority(task) {
  const urgency = task.urgency || 5;
  const importance = task.importance || 5;
  return urgency * importance; // Priority weight = urgency × importance (1-100)
}

function allSortedByPriority(includeCompleted) {
  const categorized = tasks.filter(t => t.quadrant && (includeCompleted || !t.completed));
  return categorized.sort((a, b) => {
    const priorityA = calculatePriority(a);
    const priorityB = calculatePriority(b);
    return priorityB - priorityA; // Highest priority first
  });
}

// Priority state for question-based interface
let currentPriorityTask = null;
let priorityQuestionType = null; // 'urgency' or 'importance'

function renderPrioritise() {
  const categorized = tasks.filter(t => t.quadrant && (showCompleted || !t.completed));
  
  if (!el.prioritiseBox) {
    console.error('prioritiseBox element not found!');
    return;
  }
  
  // Update show completed checkbox state
  if (el.showCompleted) {
    el.showCompleted.checked = showCompleted;
  }
  
  if (!categorized.length) {
    el.prioritiseBox.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px">No categorized tasks to prioritise.<br>Go to step 2 to categorise your tasks first.</div>';
    return;
  }

  // Group tasks by quadrant in Q1, Q2, Q3, Q4 order
  const groups = {
    Q1: categorized.filter(t => t.quadrant === 'Q1').sort((a, b) => calculatePriority(b) - calculatePriority(a)),
    Q2: categorized.filter(t => t.quadrant === 'Q2').sort((a, b) => calculatePriority(b) - calculatePriority(a)),
    Q3: categorized.filter(t => t.quadrant === 'Q3').sort((a, b) => calculatePriority(b) - calculatePriority(a)),
    Q4: categorized.filter(t => t.quadrant === 'Q4').sort((a, b) => calculatePriority(b) - calculatePriority(a))
  };

  // Check if we need to show priority rating interface
  const unprioritized = categorized.find(t => !t.urgency || !t.importance || t.urgency === 5 && t.importance === 5);
  
  if (unprioritized && !currentPriorityTask) {
    currentPriorityTask = unprioritized;
    priorityQuestionType = 'urgency';
    
    // Initialize temp values from task if they exist
    tempTimeframeValue = unprioritized.timeframeValue || 1;
    tempTimeframeUnit = unprioritized.timeframeUnit || 'weeks';
    accumulatedDays = 0; // Reset accumulator for new task
  }

  if (currentPriorityTask) {
    renderPriorityQuestion();
    return;
  }
  
  el.prioritiseBox.innerHTML = '';
  const frag = document.createDocumentFragment();

  // Render quadrant sections in Q1-Q4 order
  ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quadrant => {
    const quadrantTasks = groups[quadrant];
    if (quadrantTasks.length === 0) return;

    const section = document.createElement('div');
    section.className = 'priority-quadrant';
    section.dataset.quadrant = quadrant;
    
    // Set background colors matching categorization page
    const bgColors = {
      Q1: 'rgba(239,68,68,.08)',
      Q2: 'rgba(16,185,129,.08)', 
      Q3: 'rgba(245,158,11,.08)',
      Q4: 'rgba(99,102,241,.08)'
    };
    
    const titles = {
      Q1: 'Q1 · Urgent + Important',
      Q2: 'Q2 · Not Urgent + Important', 
      Q3: 'Q3 · Urgent + Not Important',
      Q4: 'Q4 · Not Urgent + Not Important'
    };
    
    section.style.cssText = `
      background: ${bgColors[quadrant]};
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    `;
    
    section.innerHTML = `
      <h3 class="sec-title" style="margin-bottom: 12px; font-size: 13.5px; font-weight: 800;">${titles[quadrant]}</h3>
      <div class="priority-task-list" data-quadrant="${quadrant}"></div>
    `;
    
    const taskList = section.querySelector('.priority-task-list');
    
    quadrantTasks.forEach((task, index) => {
      const priority = calculatePriority(task);
      const taskDiv = document.createElement('div');
      taskDiv.className = 'priority-task';
      taskDiv.dataset.taskId = task.id;
      taskDiv.draggable = true;
      
      taskDiv.style.cssText = `
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        background: var(--card);
        cursor: move;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      `;
      
      taskDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${task.id}')" style="accent-color: var(--accent); margin: 0;">
          <div style="flex: 1;">
            <div class="title ${task.completed ? 'strike' : ''}" style="margin-bottom: 4px; font-weight: 600;">${escapeHtml(task.title)}</div>
            <div style="font-size: 12px; color: var(--muted);">
              Priority Score: ${priority} (U:${task.urgency || 5} × I:${task.importance || 5})
            </div>
          </div>
          <div style="font-weight: 600; font-size: 16px; color: var(--accent);">#${index + 1}</div>
          <button class="btn pill ghost" onclick="editTaskPriority('${task.id}')" style="padding: 4px 8px; font-size: 11px;">Edit</button>
        </div>
      `;
      
      // Add drag and drop event listeners
      taskDiv.addEventListener('dragstart', handleDragStart);
      taskDiv.addEventListener('dragover', handleDragOver);
      taskDiv.addEventListener('drop', handleDrop);
      taskDiv.addEventListener('dragenter', handleDragEnter);
      taskDiv.addEventListener('dragleave', handleDragLeave);
      
      taskList.appendChild(taskDiv);
    });
    
    frag.appendChild(section);
  });
  
  el.prioritiseBox.appendChild(frag);
}

// Question-based priority rating interface
function renderPriorityQuestion() {
  if (!currentPriorityTask) return;
  
  if (priorityQuestionType === 'urgency') {
    // Show timeframe selector with chips + steppers UI
    const existingDuration = currentPriorityTask.duration || null;
    const components = existingDuration ? parseDuration(existingDuration) : { years: 0, months: 0, weeks: 0, days: 0 };
    const totalDays = existingDuration ? parseDurationToDays(existingDuration) : 0;
    const durationText = existingDuration ? formatDuration(existingDuration) : '';
    
    // Helper to create a stepper chip
    const createStepperChip = (unit, value, max) => {
      const label = unit.charAt(0).toUpperCase() + unit.slice(1, -1); // "years" -> "Year", "months" -> "Month"
      const isZero = value === 0;
      return `
        <div class="time-chip ${isZero ? 'collapsed' : 'expanded'}" data-unit="${unit}">
          <div class="time-chip-label">${label}${value !== 1 ? 's' : ''}</div>
          <div class="time-chip-stepper">
            <button class="stepper-btn" onclick="adjustTimeUnit('${unit}', -1)" ${value === 0 ? 'disabled' : ''} aria-label="Decrease ${unit}">−</button>
            <span class="time-value">${value}</span>
            <button class="stepper-btn" onclick="adjustTimeUnit('${unit}', 1)" ${value >= max ? 'disabled' : ''} aria-label="Increase ${unit}">+</button>
          </div>
        </div>
      `;
    };
    
    el.prioritiseBox.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div class="sec-title" style="margin-bottom: 20px;">How long do you need to complete this task?</div>
        <div class="task" style="margin: 16px auto; max-width: 400px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
          <div class="title">${escapeHtml(currentPriorityTask.title)}</div>
        </div>
        ${totalDays > 0 && durationText ? `
          <div style="background: rgba(37, 99, 235, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; margin: 16px auto; max-width: 500px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 4px;">Total Timeframe:</div>
            <div style="font-size: 18px; font-weight: 700; color: var(--text);">${durationText}</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${totalDays} total days</div>
          </div>
        ` : ''}
        <p style="color: var(--muted); font-size: 14px; margin: 16px 0 24px;">Tap to adjust your timeframe:</p>
        
        <div class="time-chips-container">
          ${createStepperChip('days', components.days, 365)}
          ${createStepperChip('weeks', components.weeks, 52)}
          ${createStepperChip('months', components.months, 11)}
          ${createStepperChip('years', components.years, 10)}
        </div>
        
        <div style="margin-top: 32px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          ${totalDays > 0 ? `<button class="btn pill ghost" onclick="resetDuration()" style="min-width: 100px;">Reset</button>` : ''}
          <button class="btn pill primary" onclick="confirmTimeframeChips()" style="min-width: 200px;">Continue</button>
        </div>
      </div>
    `;
    
    // Add styles for time chips
    if (!document.getElementById('time-chips-styles')) {
      const style = document.createElement('style');
      style.id = 'time-chips-styles';
      style.textContent = `
        .time-chips-container {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          justify-content: center;
          max-width: 400px;
          margin: 0 auto;
        }
        
        .time-chip {
          background: var(--card);
          border: 2px solid var(--border);
          border-radius: 12px;
          padding: 12px 16px;
          transition: all 0.2s ease;
          min-width: 110px;
        }
        
        .time-chip.collapsed {
          opacity: 0.6;
          border-style: dashed;
        }
        
        .time-chip.expanded {
          border-color: var(--accent);
          box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        
        .time-chip-label {
          font-size: 12px;
          font-weight: 600;
          color: var(--muted);
          margin-bottom: 8px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .time-chip-stepper {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        
        .stepper-btn {
          width: 32px;
          height: 32px;
          border-radius: 8px;
          border: 1px solid var(--border);
          background: var(--pill-bg);
          color: var(--text);
          font-size: 18px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.15s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0;
          font-family: inherit;
        }
        
        .stepper-btn:hover:not(:disabled) {
          background: var(--accent);
          color: white;
          border-color: var(--accent);
          transform: translateY(-1px);
        }
        
        .stepper-btn:active:not(:disabled) {
          transform: translateY(0);
        }
        
        .stepper-btn:disabled {
          opacity: 0.3;
          cursor: not-allowed;
        }
        
        .time-value {
          font-size: 20px;
          font-weight: 700;
          color: var(--text);
          min-width: 30px;
          text-align: center;
        }
        
        @media (max-width: 560px) {
          .time-chips-container {
            flex-direction: column;
            max-width: 200px;
          }
          
          .time-chip {
            width: 100%;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
  } else {
    // Show importance rating (unchanged)
    const questionText = 'How important is this task?';
    const subText = 'How critical is this to your goals? Would missing this significantly impact you?';
    
    el.prioritiseBox.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div class="sec-title" style="margin-bottom: 20px;">${questionText}</div>
        <div class="task" style="margin: 16px auto; max-width: 400px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
          <div class="title">${escapeHtml(currentPriorityTask.title)}</div>
        </div>
        <p style="color: var(--muted); font-size: 14px; margin: 16px 0 24px;">${subText}</p>
        
        <div class="priority-rating-grid">
          ${Array.from({length: 10}, (_, i) => {
            const rating = i + 1;
            return `<button class="btn pill priority-rating-btn" data-rating="${rating}" onclick="setPriorityRating(${rating})">${rating}</button>`;
          }).join('')}
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
          <span style="font-size: 12px; color: var(--muted);">1 = Very Low</span>
          <span style="font-size: 12px; color: var(--muted);">10 = Very High</span>
        </div>
        
        <div style="margin-top: 20px;">
          <button class="btn pill ghost" onclick="goBackToPriorityRating()" style="margin-right: 8px;">Back</button>
        </div>
      </div>
    `;
  }
}

function setPriorityRating(rating) {
  if (!currentPriorityTask) return;
  
  currentPriorityTask[priorityQuestionType] = rating;
  currentPriorityTask.updatedAt = nowMs();
  
  if (priorityQuestionType === 'urgency') {
    // Move to importance question
    priorityQuestionType = 'importance';
    renderPriorityQuestion();
  } else {
    // Finished rating this task
    saveLocal();
    queueUpload();
    
    // Find next task to prioritize
    const categorized = tasks.filter(t => t.quadrant);
    const nextUnprioritized = categorized.find(t => 
      t.id !== currentPriorityTask.id && 
      (!t.urgency || !t.importance || (t.urgency === 5 && t.importance === 5))
    );
    
    if (nextUnprioritized) {
      currentPriorityTask = nextUnprioritized;
      priorityQuestionType = 'urgency';
      renderPriorityQuestion();
    } else {
      // All tasks prioritized, show the grid view
      currentPriorityTask = null;
      priorityQuestionType = null;
      markForUpdate(['step3']);
      render();
      showSuccess('All tasks prioritized!');
    }
  }
}

function goBackToPriorityRating() {
  priorityQuestionType = 'urgency';
  renderPriorityQuestion();
}



function resetDuration() {
  if (currentPriorityTask) {
    currentPriorityTask.duration = null;
  }
  currentUnitValue = 1;
  renderPriorityQuestion();
  showSuccess('Timeframe reset');
}

// Time chips UI functions
function adjustTimeUnit(unit, delta) {
  if (!currentPriorityTask) return;
  
  // Get current components
  const components = currentPriorityTask.duration ? parseDuration(currentPriorityTask.duration) : { years: 0, months: 0, weeks: 0, days: 0 };
  
  // Define max values
  const maxValues = { years: 10, months: 11, weeks: 52, days: 365 };
  
  // Update value
  const currentValue = components[unit] || 0;
  const newValue = Math.max(0, Math.min(maxValues[unit], currentValue + delta));
  components[unit] = newValue;
  
  // Update duration
  currentPriorityTask.duration = createDuration(components.years, components.months, components.weeks, components.days);
  
  // Re-render
  renderPriorityQuestion();
}

function confirmTimeframeChips() {
  if (!currentPriorityTask) return;
  
  const duration = currentPriorityTask.duration;
  
  if (!duration) {
    showError('Please set a timeframe before continuing');
    return;
  }
  
  const totalDays = parseDurationToDays(duration);
  
  if (totalDays === 0) {
    showError('Please set a timeframe greater than 0');
    return;
  }
  
  // Calculate target date
  const now = Date.now();
  currentPriorityTask.targetDate = now + (totalDays * 24 * 60 * 60 * 1000);
  
  // Calculate urgency from timeframe
  currentPriorityTask.urgency = calculateUrgencyFromTimeframe(totalDays);
  
  currentPriorityTask.updatedAt = nowMs();
  
  // Move to importance question
  priorityQuestionType = 'importance';
  renderPriorityQuestion();
}



/**
 * Parses ISO 8601 duration into component object
 * Example: P1Y6M2W3D = { years: 1, months: 6, weeks: 2, days: 3 }
 */
function parseDuration(duration) {
  if (!duration) return { years: 0, months: 0, weeks: 0, days: 0 };
  
  const regex = /P(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)W)?(?:(\d+)D)?/;
  const match = duration.match(regex);
  
  if (!match) return { years: 0, months: 0, weeks: 0, days: 0 };
  
  return {
    years: parseInt(match[1] || 0),
    months: parseInt(match[2] || 0),
    weeks: parseInt(match[3] || 0),
    days: parseInt(match[4] || 0)
  };
}

/**
 * Converts ISO 8601 duration to total days
 * Example: P1Y6M2W3D = 1 year + 6 months + 2 weeks + 3 days
 */
function parseDurationToDays(duration) {
  const components = parseDuration(duration);
  return (components.years * 365) + (components.months * 30) + (components.weeks * 7) + components.days;
}

/**
 * Creates ISO 8601 duration from components
 * Example: createDuration(1, 6, 2, 3) = "P1Y6M2W3D"
 */
function createDuration(years = 0, months = 0, weeks = 0, days = 0) {
  if (years === 0 && months === 0 && weeks === 0 && days === 0) return null;
  
  let duration = 'P';
  if (years > 0) duration += `${years}Y`;
  if (months > 0) duration += `${months}M`;
  if (weeks > 0) duration += `${weeks}W`;
  if (days > 0) duration += `${days}D`;
  
  return duration;
}

/**
 * Formats duration for display
 * Example: P1Y6M2W3D = "1 year, 6 months, 2 weeks, 3 days"
 */
function formatDuration(duration) {
  if (!duration) return '';
  
  const regex = /P(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)W)?(?:(\d+)D)?/;
  const match = duration.match(regex);
  
  if (!match) return '';
  
  const parts = [];
  const years = parseInt(match[1] || 0);
  const months = parseInt(match[2] || 0);
  const weeks = parseInt(match[3] || 0);
  const days = parseInt(match[4] || 0);
  
  if (years > 0) parts.push(`${years} year${years > 1 ? 's' : ''}`);
  if (months > 0) parts.push(`${months} month${months > 1 ? 's' : ''}`);
  if (weeks > 0) parts.push(`${weeks} week${weeks > 1 ? 's' : ''}`);
  if (days > 0) parts.push(`${days} day${days > 1 ? 's' : ''}`);
  
  return parts.join(', ');
}

/**
 * Converts timeframe (in days) to urgency score (1-10)
 * Uses logarithmic scaling to provide intuitive urgency ratings:
 * - 1 day or less = 10 (most urgent)
 * - 1 week = 8
 * - 1 month = 5
 * - 6 months = 3
 * - 1 year or more = 1 (least urgent)
 */
function calculateUrgencyFromTimeframe(totalDays) {
  if (totalDays <= 0) return 10; // Immediate/overdue
  if (totalDays <= 1) return 10; // Today
  if (totalDays <= 2) return 9;  // Tomorrow
  if (totalDays <= 7) return 8;  // This week
  if (totalDays <= 14) return 7; // 2 weeks
  if (totalDays <= 30) return 5; // 1 month
  if (totalDays <= 60) return 4; // 2 months
  if (totalDays <= 180) return 3; // 6 months
  if (totalDays <= 365) return 2; // 1 year
  return 1; // More than 1 year
}

function editTaskPriority(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  currentPriorityTask = task;
  priorityQuestionType = 'urgency';
  
  renderPriorityQuestion();
}

// Drag and drop functionality
let draggedElement = null;

function handleDragStart(e) {
  draggedElement = e.target;
  e.target.style.opacity = '0.5';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', e.target.outerHTML);
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
  e.preventDefault();
  if (e.target.classList.contains('priority-task-list')) {
    e.target.style.background = 'rgba(var(--accent-rgb), 0.1)';
  }
}

function handleDragLeave(e) {
  if (e.target.classList.contains('priority-task-list')) {
    e.target.style.background = '';
  }
}

function handleDrop(e) {
  e.preventDefault();
  
  if (e.target.classList.contains('priority-task-list')) {
    e.target.style.background = '';
    
    const newQuadrant = e.target.dataset.quadrant;
    const taskId = draggedElement.dataset.taskId;
    const task = tasks.find(t => t.id === taskId);
    
    if (task && newQuadrant && task.quadrant !== newQuadrant) {
      // Update task quadrant
      task.quadrant = newQuadrant;
      task.updatedAt = nowMs();
      task.rank = null; // Reset rank in new quadrant
      
      saveLocal();
      queueUpload();
      markForUpdate(['step2', 'step3']);
      render();
      
      showSuccess(`Moved task to ${newQuadrant}`);
    }
  }
  
  if (draggedElement) {
    draggedElement.style.opacity = '';
    draggedElement = null;
  }
}

function updateTaskScore(taskId, type, value) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  const numValue = parseInt(value);
  task[type] = numValue;
  task.updatedAt = nowMs();
  
  // Save and re-render to update order
  saveLocal();
  queueUpload();
  setTimeout(() => {
    markForUpdate(['step3']);
    render();
  }, 100);
}

// Task completion toggle function
function toggleTaskCompletion(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  task.completed = !task.completed;
  task.updatedAt = nowMs();
  
  saveLocal();
  queueUpload();
  markForUpdate(['step3']);
  render();
}
function renderSuggestions(){ const sugg=computeSuggestions(); el.suggestions.innerHTML=''; const frag=document.createDocumentFragment(); sugg.forEach(s=>{ const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=s; b.onclick=()=>applySuggestion(s); frag.appendChild(b); }); el.suggestions.appendChild(frag); }
function updateList(container, items, opts, emptyMsg){ if(!items.length){ const li=document.createElement('li'); li.className='empty-state'; li.setAttribute('role','listitem'); li.setAttribute('aria-live','polite'); li.innerHTML=`<p>${escapeHtml(emptyMsg)}</p>`; container.innerHTML=''; container.appendChild(li); return; } const frag=document.createDocumentFragment(); items.forEach(item=> frag.appendChild(rowItem(item,opts))); container.innerHTML=''; container.appendChild(frag); }
function updateCategoriseBox(current){ if(!current){ el.categoriseBox.innerHTML='<div class="muted" style="text-align:center" role="status">No uncategorised tasks.</div>'; }
  else if(answeredUrgent===null){ el.categoriseBox.innerHTML = `
    <div class="sec-title">Categorise</div>
    <div class="task"><div class="title">${escapeHtml(current.title)}</div><div class="spacer"></div></div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn pill primary" onclick="answerUrgent(true)">Urgent</button>
      <button class="btn pill ghost" onclick="answerUrgent(false)">Not urgent</button>
    </div>`; }
  else { el.categoriseBox.innerHTML = `
    <div class="sec-title">Categorise</div>
    <div class="task"><div class="title">${escapeHtml(current.title)}</div><div class="spacer"></div></div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn pill primary" onclick="answerImportant(true)">Important</button>
      <button class="btn pill ghost" onclick="answerImportant(false)">Not important</button>
    </div>
    <div class="btnrow" style="margin-top:8px">
      <button class="btn pill ghost" onclick="answerUrgent(null)">Back</button>
    </div>`; } }
function markForUpdate(parts=['step1','step2','step3']){ parts.forEach(p=>{ if(p in renderState) renderState[p]=true; }); }
function rowItem(t,opts){ const li=document.createElement('li'); li.dataset.id=t.id; li.className='task'+((opts&&opts.showQuadrant&&t.quadrant)?(' q-'+t.quadrant):''); li.setAttribute('role','listitem'); const cb=document.createElement('input'); cb.type='checkbox'; cb.id=`task-${t.id}`; cb.checked=t.completed; cb.setAttribute('aria-describedby',`task-title-${t.id}`); cb.onchange=()=>{ t.completed=!t.completed; t.updatedAt=Date.now(); saveLocal(); queueUpload(); const updates=['step3']; if(!t.quadrant) updates.push('step1'); if(t.quadrant) updates.push('step2'); markForUpdate(updates); render(); }; const title=document.createElement('div'); title.className='title'; title.id=`task-title-${t.id}`; title.textContent=t.title||''; if(t.completed){ title.className+=' strike'; } if(opts&&opts.showQuadrant&&t.quadrant){ const pill=document.createElement('span'); pill.className='qpill '+t.quadrant; pill.textContent=t.quadrant; pill.setAttribute('aria-label',`Priority quadrant ${t.quadrant}`); title.appendChild(pill); }
  const spacer=document.createElement('div'); spacer.className='spacer'; const del=document.createElement('button'); del.className='btn pill ghost closebtn'; del.textContent='×'; del.setAttribute('aria-label',`Delete task: ${t.title}`); del.title='Delete task'; del.onclick=()=> requestDelete(t, ()=>{ tasks = tasks.filter(x=>x.id!==t.id); saveLocal(); queueUpload(); __recordDelete(); markForUpdate(['step1','step2','step3']); render(); }); li.append(cb,title,spacer,del); return li; }
function mountQuadrantList(container, arr, key){ if(!arr.length){ const li=document.createElement('li'); li.className='empty-state'; li.setAttribute('role','listitem'); li.style.padding='20px'; li.innerHTML='<p style="font-size:13px;color:var(--muted)">No tasks in this quadrant</p>'; container.innerHTML=''; container.appendChild(li); return; } const frag=document.createDocumentFragment(); arr.forEach(t=>{ frag.appendChild(createQuadrantListItem(t,key)); }); container.innerHTML=''; container.appendChild(frag); }
function createQuadrantListItem(t,key){ const li=document.createElement('li'); li.className='task quadrant-task'; li.dataset.id=t.id; li.setAttribute('role','listitem'); const title=document.createElement('div'); title.className='title'; title.id=`task-title-${key}-${t.id}`; title.textContent=t.title||''; if(t.completed){ title.className+=' strike'; } const spacer=document.createElement('div'); spacer.className='spacer'; const actions=document.createElement('div'); actions.className='row-actions'; actions.setAttribute('role','group'); actions.setAttribute('aria-label',`Actions for ${t.title}`);
  const decat=document.createElement('button'); decat.className='btn pill ghost'; decat.setAttribute('aria-label',`Reset category for ${t.title}`); decat.title='Reset category'; decat.textContent='Reset Category'; decat.onclick=()=>{ t.quadrant=null; t.rank=null; t.updatedAt=Date.now(); saveLocal(); queueUpload(); markForUpdate(['step1','step2','step3']); render(); };
  actions.append(decat); li.append(title,spacer,actions); return li; }

/* ========= Settings modal ========= */
const modal=document.getElementById('settingsModal');


function applyFont(f){ document.documentElement.style.setProperty('--font-family', f); saveUserSettings(); }
function exportTasks(){ const data={ tasks, settings: JSON.parse(localStorage.getItem('covey_settings')||'{}'), exported:new Date().toISOString() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`covey-todo-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); showSuccess('Tasks exported'); }
function importTasks(file){ if(!file) return; const r=new FileReader(); r.onload=(e)=>{ try{ const data=JSON.parse(e.target.result); if(data.tasks && Array.isArray(data.tasks)){ if(confirm(`Import ${data.tasks.length} tasks? This will replace your current tasks.`)){ tasks=data.tasks; saveLocal(); queueUpload(); markForUpdate(['step1','step2','step3']); renderState.suggestions=true; render(); showSuccess(`Imported ${data.tasks.length} tasks`); } } else { showError('Invalid file format'); } } catch(err){ console.error('Import error:',err); showError('Failed to import tasks'); } }; r.readAsText(file); el.importFile.value=''; }
function saveUserSettings(){ try{ const s={ fontFamily: el.fontSelect?.value || 'system-ui, -apple-system, \'Segoe UI\', Roboto, Inter, Arial, sans-serif', confirmDeletes: el.confirmDeletes?.checked !== false, enableAnimations: el.enableAnimations?.checked !== false, autoFocusInput: el.autoFocusInput?.checked !== false }; localStorage.setItem('covey_settings', JSON.stringify(s)); }catch(e){ console.warn('Could not save settings:', e); }}
function loadUserSettings(){ try{ const s=JSON.parse(localStorage.getItem('covey_settings')||'{}'); if(s.fontFamily){ document.documentElement.style.setProperty('--font-family', s.fontFamily); } return s; }catch(e){ return {}; }}

/* ========= Authentication modal ========= */
let currentUser=null;
byId('signInBtn').onclick=()=> openSignIn();
byId('closeSignIn').onclick=()=> closeSignIn();
function openSignIn(){ el.signInModal.style.display='flex'; el.signInModal.setAttribute('aria-hidden','false'); setTimeout(()=> el.emailInput.focus(),100); }
function closeSignIn(){ el.signInModal.style.display='none'; el.signInModal.setAttribute('aria-hidden','true'); el.signInBtn.focus(); }
function updateAuthUI(user){ currentUser=user; if(user){ el.authStatus.textContent='Signed in'; el.signInBtn.textContent='Account'; el.signInBtn.onclick=()=> showAccountMenu(); } else { el.authStatus.textContent='Signed out'; el.signInBtn.textContent='Sign in'; el.signInBtn.onclick=()=> openSignIn(); } }
function showAccountMenu(){ if(confirm('Sign out of your account?')){ signOut(); } }

// Firebase
let firebaseApp=null; let auth=null;
function userDocRef(uid){ return db.collection('users').doc(uid).collection('lists').doc('default'); }
function initializeFirebase(){ try{
  const firebaseConfig={
    apiKey:"AIzaSyA_30R8nbkxbfZFMlFk3ZrAVd64GnT5Bdc",
    authDomain:"covey-to-do-minimal.firebaseapp.com",
    projectId:"covey-to-do-minimal",
    storageBucket:"covey-to-do-minimal.appspot.com", // fixed domain
    messagingSenderId:"347259300013",
    appId:"1:347259300013:web:5118af8df57c0f064f3e24",
    measurementId:"G-XTK3S2LK46"
  };
  if(typeof firebase!=='undefined'){
    firebaseApp=firebase.initializeApp(firebaseConfig);
    auth=firebase.auth();
    db=firebase.firestore();

    // Auth state + realtime listener management
    auth.onAuthStateChanged(async (user)=>{
      updateAuthUI(user);
      if(unsubscribe){ unsubscribe(); unsubscribe=null; }
      if(!user || !db) return;
      const ref=userDocRef(user.uid);
      const snap=await ref.get();
      if(!snap.exists){ await ref.set({ tasks: tasks||[], updatedAt: Date.now() }); }
      unsubscribe = ref.onSnapshot((doc)=>{
        const data = doc.data() || {};
        const remoteTasks = Array.isArray(data.tasks)? data.tasks : [];
        const remoteUpdated = Number(data.updatedAt || 0);
        if(remoteUpdated > lastPushedAt){
          tasks = remoteTasks.map(task => ({ ...task, timeframeValue: task.timeframeValue !== undefined ? task.timeframeValue : null, timeframeUnit: task.timeframeUnit !== undefined ? task.timeframeUnit : null, targetDate: task.targetDate !== undefined ? task.targetDate : null }));
          saveLocal();
          markForUpdate(['step1','step2','step3']);
          render();
        }
      });
    });
  } else { throw new Error('Firebase SDK not loaded'); }
 } catch(err){ console.error('Firebase init error:',err); }
}

function signInWithEmail(email,password){ if(!isFirebaseReady()){ showError('Cloud sync not configured - sign in disabled'); return; } el.authStatusModal.textContent='Signing in...'; auth.signInWithEmailAndPassword(email,password).then(()=>{ closeSignIn(); showSuccess('Signed in!'); el.authStatusModal.textContent='Idle'; }).catch(err=>{ console.error('Sign-in error:',err); showError(`Sign-in failed: ${err.message}`); el.authStatusModal.textContent='Idle'; }); }
function createAccount(email,password){ if(!isFirebaseReady()){ showError('Cloud sync not configured - account creation disabled'); return; } el.authStatusModal.textContent='Creating account...'; auth.createUserWithEmailAndPassword(email,password).then(()=>{ closeSignIn(); showSuccess('Account created!'); el.authStatusModal.textContent='Idle'; }).catch(err=>{ console.error('Create error:',err); showError(`Account creation failed: ${err.message}`); el.authStatusModal.textContent='Idle'; }); }
function signInWithGoogle(){ if(!isFirebaseReady()){ showError('Cloud sync not configured - Google sign in disabled'); return; } el.authStatusModal.textContent='Connecting to Google...'; const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(()=>{ closeSignIn(); showSuccess('Signed in with Google!'); el.authStatusModal.textContent='Idle'; }).catch(err=>{ console.error('Google sign-in error:',err); showError(`Google sign-in failed: ${err.message}`); el.authStatusModal.textContent='Idle'; }); }
function signOut(){ if(!auth){ updateAuthUI(null); showInfo('Signed out'); return; } auth.signOut().then(()=>{ updateAuthUI(null); showInfo('Signed out'); }).catch(()=> showError('Sign-out failed')); }


/* ========= Error Handling & Notifications ========= */
let notificationTimeout=null;
function showNotification(message,type='info'){ if(notificationTimeout) clearTimeout(notificationTimeout); const existing=document.querySelector('.notification'); if(existing) existing.remove(); const n=document.createElement('div'); n.className=`notification notification-${type}`; n.textContent=message; n.setAttribute('role','alert'); n.setAttribute('aria-live','polite'); Object.assign(n.style,{position:'fixed',top:'20px',left:'50%',marginLeft:'-150px',background:type==='error'? '#ef4444' : type==='success'? '#10b981' : '#2563eb',color:'#fff',padding:'12px 20px',borderRadius:'8px',boxShadow:'0 4px 12px rgba(0,0,0,.15)',zIndex:'1000',maxWidth:'300px',fontSize:'14px',textAlign:'center',transform:'translateY(-100%)',transition:'transform .3s ease'}); document.body.appendChild(n); setTimeout(()=>{ n.style.transform='translateY(0)'; },10); notificationTimeout=setTimeout(()=>{ n.style.transform='translateY(-100%)'; setTimeout(()=>{ if(n.parentNode) n.parentNode.removeChild(n); },300); },4000); }
function showError(m){ showNotification(m,'error'); }
function showSuccess(m){ showNotification(m,'success'); }
function addSuccessFlash(elm){ elm.classList.add('success-flash'); setTimeout(()=> elm.classList.remove('success-flash'),600); }
function addLoadingState(elm){ elm.classList.add('loading'); }
function removeLoadingState(elm){ elm.classList.remove('loading'); }
function submitWithFeedback(form, fn){ addLoadingState(form); try{ const r=fn(); if(r instanceof Promise){ return r.finally(()=> removeLoadingState(form)); } removeLoadingState(form); return r; } catch(e){ removeLoadingState(form); throw e; } }
function showInfo(m){ showNotification(m,'info'); }
function requestDelete(task, cb){ let confirmDeletes=true; try{ const s=JSON.parse(localStorage.getItem('covey_settings')||'{}'); confirmDeletes = s.confirmDeletes !== false; }catch{} if(!confirmDeletes || confirm(`Delete "${task.title}"?`)){ try{ cb(); showSuccess('Task deleted'); } catch(e){ showError('Failed to delete task'); } } }
function byId(id){ return document.getElementById(id); }
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

function __recordDelete(){}
function loadSettingsIntoUI(){ try{ const s=JSON.parse(localStorage.getItem('covey_settings')||'{}'); if(el.fontSelect && s.fontFamily) el.fontSelect.value=s.fontFamily; if(el.confirmDeletes) el.confirmDeletes.checked = s.confirmDeletes !== false; if(el.enableAnimations) el.enableAnimations.checked = s.enableAnimations !== false; if(el.autoFocusInput) el.autoFocusInput.checked = s.autoFocusInput !== false; }catch{} }
function isFirebaseReady(){ return !!(window.firebase && firebase.apps && firebase.apps.length && auth && db); }

// Cloud sync (debounced push)
let pushTimer=null;
function queueUpload(force=false){ if(!currentUser || !db) return; const push=async()=>{ try{ lastPushedAt = Date.now(); await userDocRef(currentUser.uid).set({ tasks, updatedAt:lastPushedAt }, { merge:true }); } catch(e){ console.error('Sync push failed:',e); showError('Cloud sync failed. Will retry.'); } }; if(force){ clearTimeout(pushTimer); push(); } else { clearTimeout(pushTimer); pushTimer=setTimeout(push, 400); } }

/* ========= Modal helpers ========= */
function openSettings(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); loadSettingsIntoUI(); buildSwatches(); setTimeout(()=>{ const first=modal.querySelector('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'); if(first) first.focus(); },100); }
function closeSettings(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); el.settingsBtn.focus(); }

/* ========= Global error guards ========= */
window.addEventListener('error', (event)=>{ console.error('Global error:', event.error); const msg=event.error?.message || event.message || 'An unexpected error occurred'; if(msg.includes('Firebase')){ console.warn('Firebase not fully configured'); return; } showError(`Error: ${msg}`); });
window.addEventListener('unhandledrejection', (event)=>{ console.error('Unhandled rejection:', event.reason); const msg=event.reason?.message || event.reason?.code || 'Operation failed'; if(typeof event.reason==='string' && event.reason.includes('Firebase')){ console.warn('Firebase not fully configured'); return; } showError(`Error: ${msg}`); });

/* ========= Early Init (theme/settings before DOM) ========= */
try{
  initAccent();
  loadUserSettings();
} catch(e){ 
  console.error('Early initialization error:', e);
}
</script>
</body>
</html>
